<beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:beans="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:p="http://www.springframework.org/schema/p" xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
       					   http://www.springframework.org/schema/beans/spring-beans.xsd
       					   http://www.springframework.org/schema/util 
       					   http://www.springframework.org/schema/util/spring-util.xsd   
       					   http://www.springframework.org/schema/security   
       					   http://www.springframework.org/schema/security/spring-security.xsd">

	<global-method-security secured-annotations="enabled" />

	<http auto-config="false" use-expressions="true"
		access-denied-page="/login.action?authfailed=true" entry-point-ref="entryPoint">
		<intercept-url pattern="/**/*login*" access="permitAll" />
		<intercept-url pattern="/**/*changePwd*" access="permitAll" />
		<intercept-url pattern="/**/*image*/**" access="permitAll" />
		<intercept-url pattern="/**/*upload*/**" access="permitAll" />
		<intercept-url pattern="/**/js*/**" access="permitAll" />
		<intercept-url pattern="/**/css/**" access="permitAll" />
		<intercept-url pattern="/**/html/**" access="permitAll" />
		<intercept-url pattern="/**/monitoring/**" access="permitAll" />
		<intercept-url pattern="/**/applet/**" access="permitAll" />
		<intercept-url pattern="/**/dojo*/**" access="permitAll" />
		<intercept-url pattern="/**/ws/**" access="permitAll" />
		<intercept-url pattern="/externalSystemLogin*" access="permitAll" />
		
		<intercept-url pattern="/**"	access="hasAnyRole('ROLE_IGERIV_BASE','ROLE_IGERIV_BASE_ADMIN','ROLE_IGERIV_BASE_ADMIN_DEVIETTI_TODIS','ROLE_IGERIV_LITE','ROLE_IGERIV_TEST','ROLE_IGERIV_STARTER','ROLE_IGERIV_ADV_2','ROLE_IGERIV_ADV_3','ROLE_IGERIV_ADV_4','ROLE_ADMIN','ROLE_IGERIV_BASE_ARCIRC','ROLE_CHIMI_LIGHT_IMG','ROLE_IGERIV_BASIC_RG',
															'ROLE_IGERIV_SILVER_RG','ROLE_IGERIV_GOLD_RG','ROLE_IGERIV_BASIC_COMUZZI','ROLE_IGERIV_SILVER_COMUZZI','ROLE_IGERIV_GOLD_COMUZZI','ROLE_IGERIV_BASIC_REBECCHI',
															'ROLE_IGERIV_SILVER_REBECCHI','ROLE_IGERIV_GOLD_REBECCHI','ROLE_IGERIV_BASIC_CDL','ROLE_IGERIV_SILVER_CDL','ROLE_IGERIV_GOLD_CDL','ROLE_IGERIV_BASIC_RUGGIERO','ROLE_IGERIV_SILVER_RUGGIERO','ROLE_IGERIV_GOLD_RUGGIERO',
															'ROLE_IGERIV_BASIC_LOBUONO','ROLE_IGERIV_GOLD_LOBUONO')" />
		<logout />

		<custom-filter position="PRE_AUTH_FILTER" ref="emailValidationFilter" />
		<custom-filter position="CONCURRENT_SESSION_FILTER" ref="concurrencyFilter" />
		<custom-filter position="FORM_LOGIN_FILTER" ref="userPwdAuthFilter" />
		<custom-filter position="OPENID_FILTER" ref="openIdAuthFilter" />
		<custom-filter before="LAST" ref="filterListWrappper" />
		<session-management session-authentication-strategy-ref="sas" />
	</http>
	
	<!-- TEST LOGIN EXTERNAL SYSTEM 
	<http auto-config="false" use-expressions="true" access-denied-page="/login.action?authfailed=true" entry-point-ref="entryPoint_ext">
		<intercept-url pattern="/j_spring_security_check_ext*" access="hasAnyRole('ROLE_IGERIV_BASE_ADMIN','ROLE_IGERIV_BASIC_COMUZZI','ROLE_IGERIV_SILVER_COMUZZI')" />
		<logout />
		<custom-filter position="FORM_LOGIN_FILTER" ref="externalUserPwdAuthFilter" />
	</http>
	
	<beans:bean id="entryPoint_ext" 	class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint">
		<beans:property name="loginFormUrl" value="/login.action" />
	</beans:bean>

	<beans:bean id="externalUserPwdAuthFilter"	class="it.dpe.igeriv.security.UrlAuthenticationFilter">
		
	</beans:bean>

	 @fine -->


	<beans:bean id="concurrencyFilter"	class="org.springframework.security.web.session.ConcurrentSessionFilter">
		<beans:property name="sessionRegistry" ref="sessionRegistry" />
		<beans:property name="expiredUrl" value="/j_spring_security_logout" />
	</beans:bean>

	<beans:bean id="sessionRegistry"	class="org.springframework.security.core.session.SessionRegistryImpl" />

	<beans:bean id="sas" class="org.springframework.security.web.authentication.session.ConcurrentSessionControlStrategy">
		<beans:constructor-arg name="sessionRegistry"	ref="sessionRegistry" />
		<beans:property name="maximumSessions" value="1" />
	</beans:bean>

	<beans:bean id="userPwdAuthFilter"	class="it.dpe.igeriv.security.IGerivUsernamePasswordAuthenticationFilter">
		<beans:property name="sessionAuthenticationStrategy"	ref="sas" />
		<beans:property name="authenticationManager" 			ref="authenticationManager" />
		<beans:property name="edicoleService" 					ref="EdicoleService" />
		<beans:property name="accountService" 					ref="AccountService" />
		<beans:property name="iGerivLoginSessionConfigurer"		ref="IGerivLoginSessionConfigurer" />
		<beans:property name="authenticationSuccessHandler">
			<beans:bean class="org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler">
				<beans:property name="defaultTargetUrl" value="/home.action" />
			</beans:bean>
		</beans:property>
		<beans:property name="authenticationFailureHandler">
			<beans:bean class="org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler">
				<beans:property name="defaultFailureUrl" value="/login.action?authfailed=true" />
			</beans:bean>
		</beans:property>
		<beans:property name="minicardInputModuleListener" ref="MinicardInputModuleListener" />
	</beans:bean>

	<beans:bean id="openIdAuthFilter"
		class="it.dpe.igeriv.security.openid.IGerivOpenIDAuthenticationFilter">
		<beans:property name="authenticationManager" ref="authenticationManager" />
		<beans:property name="accountService" ref="AccountService" />
		<beans:property name="iGerivLoginSessionConfigurer"
			ref="IGerivLoginSessionConfigurer" />
		<beans:property name="authenticationSuccessHandler">
			<beans:bean class="org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler">
				<beans:property name="defaultTargetUrl" value="/home.action" />
			</beans:bean>
		</beans:property>
		<beans:property name="authenticationFailureHandler">
			<beans:bean	class="org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler">
				<beans:property name="defaultFailureUrl" value="/login.action?authfailed=true" />
			</beans:bean>
		</beans:property>
		<beans:property name="consumer">
			<beans:bean class="it.dpe.igeriv.security.openid.IGerivOpenID4JavaConsumer">
				<beans:constructor-arg index="0">
					<beans:bean class="org.openid4java.consumer.ConsumerManager" />
				</beans:constructor-arg>
				<beans:constructor-arg index="1">
					<beans:list value-type="org.springframework.security.openid.OpenIDAttribute">
						<beans:bean class="org.springframework.security.openid.OpenIDAttribute">
							<beans:constructor-arg index="0" value="email" />
							<beans:constructor-arg index="1"
								value="http://schema.openid.net/contact/email" />
							<beans:property name="required" value="true" />
						</beans:bean>
						<beans:bean class="org.springframework.security.openid.OpenIDAttribute">
							<beans:constructor-arg index="0" value="firstName" />
							<beans:constructor-arg index="1"
								value="http://axschema.org/namePerson/first" />
							<beans:property name="required" value="true" />
						</beans:bean>
						<beans:bean class="org.springframework.security.openid.OpenIDAttribute">
							<beans:constructor-arg index="0" value="lastName" />
							<beans:constructor-arg index="1"
								value="http://axschema.org/namePerson/last" />
							<beans:property name="required" value="true" />
						</beans:bean>
					</beans:list>
				</beans:constructor-arg>
			</beans:bean>
		</beans:property>
	</beans:bean>



	



	<beans:bean name="org.springframework.security.authenticationManager"
		id="authenticationManager" class="org.springframework.security.authentication.ProviderManager">
		<beans:property name="providers">
			<beans:list>
				<beans:ref bean="authProvider" />
				<beans:ref bean="openIdAuthProvider" />
			</beans:list>
		</beans:property>
	</beans:bean>

	<beans:bean id="authProvider"
		class="it.dpe.igeriv.security.IGerivDaoAuthenticationProvider">
		<beans:property name="userDetailsService" ref="IGerivUserDetailsService" />
		<beans:property name="saltSource" ref="saltSource" />
		<beans:property name="passwordEncoder" ref="passwordEncoder" />
	</beans:bean>

	<beans:bean id="openIdAuthProvider"
		class="it.dpe.igeriv.security.openid.IGerivOpenIDAuthenticationProvider">
		<beans:property name="userDetailsService" ref="IGerivOpenIdUserDetailsService" />
	</beans:bean>

	<beans:bean id="entryPoint" 	class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint">
		<beans:property name="loginFormUrl" value="/login.action" />
	</beans:bean>

	<beans:bean id="passwordEncoder"
		class="org.springframework.security.authentication.encoding.ShaPasswordEncoder">
		<beans:constructor-arg value="1" />
	</beans:bean>

	<beans:bean id="saltSource"
		class="org.springframework.security.authentication.dao.ReflectionSaltSource">
		<beans:property name="userPropertyToUse" value="userSalt" />
	</beans:bean>

	<beans:bean id="myAuthenticationFilter" class="it.dpe.igeriv.security.UrlAuthenticationFilter" />


</beans:beans>