dojo.require("dojox.grid.DataGrid");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dojo.rpc.RpcService");dojo.require("dojo.rpc.JsonService");dojo.require("dijit.Tree");dojo.require("dijit.tree.ForestStoreModel");
var mostSoldBarPos=0,mostSoldBarSizes=0,currentPage=0,abilitaResto=false,includiPubblicazioniScontrino=false,ricercaProdottiVari=false,barcodeHit=false,modalita="CONSEGNA",selectedBarcode="",width1="",width2="",width3="",objSeparator=null,objSeparatorL=null,service=null,objMain=null,venditeTableObject=null,contiTreeObject=null;
function itemToJSON(a,b){var c={};if(b&&a){var d=a.getAttributes(b);if(d&&d.length>0){var e;for(e=0;e<d.length;e++){var f=a.getValues(b,d[e]);if(f)if(f.length>1){var h;c[d[e]]=[];for(h=0;h<f.length;h++){var g=f[h];a.isItem(g)?c[d[e]].push(dojo.fromJson(itemToJSON(a,g))):c[d[e]].push(g)}}else c[d[e]]=a.isItem(f[0])?dojo.fromJson(itemToJSON(a,f[0])):f[0]}}}return dojo.toJson(c)}
function confirmSendErrorToDpe(){unBlockInputText();jConfirm(sendErrorToDpeConfirmMsg,attenzioneMsg,function(a){a&&regCassaApplet.sendLogFile();$("#inputText").focus()},true,false)}function getJsonStoreString(a){var b=[];a.store.fetch({query:{},onItem:function(c){b.push(itemToJSON(a.store,c))}});return"{list:["+b+"]}"}function getStoreLength(a){var b=0;a.store.fetch({query:{},onItem:function(){b++}});return b}
function setTableData(a,b,c){b=new dojo.data.ItemFileWriteStore({data:{identifier:b,items:c}});a.setStore(b);a.store=b;if(a==venditeTableObject){dojo.connect(b,"onNew",function(d){onVenditeTableAdd(d)});dojo.connect(b,"onDelete",function(){onVenditeTableDelete()})}}function addTableData(a,b,c){if(a.store)if(c.length)for(b=0;b<c.length;b++)a.store.newItem(c[b]);else a.store.newItem(c);else setTableData(a,b,c)}
function setTotals(){var a=0,b=0,c=0,d=0,e=0;venditeTableObject.store.fetch({query:{},onItem:function(f){var h=typeof f.prodottoNonEditoriale==="undefined"?false:f.prodottoNonEditoriale=="true"?true:false,g=Number(f.quantita);d+=g;e=g*Number(f.prezzoCopertina);a+=e;if(h)b+=e;else c+=e}});a=a.toFixed(2);b=b.toFixed(2);c=c.toFixed(2);$("#totale").val(displayNum(a));$("#totaleScontrino").length>0&&$("#totaleScontrino").val(displayNum(b));$("#totalePubb").length>0&&$("#totalePubb").val(displayNum(c));
$("#totalePezzi").val(d)}function onVenditeTableAdd(a){typeof a!=="undefined"&&setGiacenzaPub(a);setTotals();setTimeout(function(){addRightClickMenu();setScrollBarToBottom();$("#inputText").val("");$("#inputText").focus()},100)}
function setGiacenzaPub(a){if(a.prodottoNonEditoriale.toString()=="false"&&!isNaN(a.giacenzaIniziale)){var b=a.idtn.toString(),c=Number(a.giacenzaIniziale),d=0,e=0;venditeTableObject.store.fetch({query:{idtn:b},onItem:function(f){e+=Number(f.quantita);d=c-e},onComplete:function(){venditeTableObject.store.setValue(a,"giacenzaIniziale",d)}})}}
function onVenditeTableDelete(){setTotals();venditeTableObject.store.save();setTimeout(function(){addRightClickMenu();setScrollBarToBottom();$("#inputText").val("");$("#inputText").focus()},100)}
dojo.addOnLoad(function(){venditeTableObject=dijit.byId("venditeTable");showLeftSideBar||hideSidebarL();showRightSideBar||hideSidebar();setTableData(venditeTableObject,venditeTabIdField,[]);dojo.extend(dijit.Tree,{refreshModel:function(){this.dndController.selectNone();this.model.store.clearOnClose=true;this.model.store.close();this._itemNodesMap={};this.rootNode.state="UNCHECKED";this.model.root.children=null;this.rootNode&&this.rootNode.destroyRecursive();this._load()}});var a=new dojo.data.ItemFileWriteStore({data:[]});
a=new dijit.tree.ForestStoreModel({store:a,query:{type:"parent"},rootId:"root",rootLabel:"Groups",childrenAttrs:["children"]});contiTreeObject=new dijit.Tree({model:a,openOnClick:true,showRoot:false,collapseAll:true,_createTreeNode:function(c){var d=new dijit._TreeNode(c);d.labelNode.innerHTML=c.label;return d},onDblClick:function(c){treeDoubleClick(c)}},"treeDiv");dojo.connect(contiTreeObject,"onKeyDown",b,function(c){if((c.keyCode?c.keyCode:c.charCode)==27){$("#inputText").focus();$("#close").trigger("click")}});
service=new dojo.rpc.JsonService(smdUrl);loadLocalStorage();$("#ricercaProdottiVari").change(function(){if($(this).attr("checked")==true){service.setRicercaProdottiVari("true");$("#inputText").focus(function(){$(this).css("background","#ffcccc")});ricercaProdottiVari=true}else{service.setRicercaProdottiVari("false");$("#inputText").focus(function(){$(this).css("background","#ffff99")});ricercaProdottiVari=false}$("#inputText").focus()});$("#mostraTutteUscite").change(function(){$("#inputText").focus()});
$("#aggiornaBarcode").change(function(){$("#inputText").focus()});idContoCliente!=null&&idContoCliente.trim()!=""&&service.getConto(idContoCliente).addCallback(function(c){addTableData(venditeTableObject,venditeTabIdField,c);$("#idConto").val(idContoCliente);setTimeout(function(){setScrollBarToBottom();addRightClickMenu()},100);service.deleteConto(Number(idContoCliente)).addCallback(function(d){var e=d.result,f={},h={};venditeTableObject.store.fetch({query:{},onItem:function(g){var k=g.idtn,i=g.idProdotto;
f[k]=typeof f[k]==="undefined"?1:Number(f[k])+1;h[i]=typeof h[i]==="undefined"?1:Number(h[i])+1;var m=typeof g.prodottoNonEditoriale!=="undefined"&&g.prodottoNonEditoriale.toString()=="true"?true:false;if(m)if(h[i]==1)mapGiacenze["prod_"+i]=e["pne_"+i];k=m?mapGiacenze["prod_"+i]:e["pub_"+k]-f[k];if(m)mapGiacenze["prod_"+i]=getLastGiacenza(i)-1;venditeTableObject.store.setValue(g,"giacenzaIniziale",k)}})})});var b=dijit.byId("pubblicazioniTable");dojo.connect(b,"onRowClick",function(){onSelectPubblicazioniTable()});
dojo.connect(b,"onKeyDown",b,function(c){c=c.keyCode?c.keyCode:c.charCode;if(c==13)this.getRowNode(this.focus.rowIndex).trigger("click");else if(c==27){$("#inputText").focus();$("#close").trigger("click")}});a=dijit.byId("ricaricheTable");dojo.connect(a,"onRowClick",function(){onSelectRicaricheTable()});dojo.connect(a,"onKeyDown",b,function(c){c=c.keyCode?c.keyCode:c.charCode;if(c!=13)if(c==27){$("#inputText").focus();$("#close").trigger("click")}});b=dijit.byId("pubblicazioniTableBarcode");dojo.connect(b,
"onRowClick",function(){onSelectPubblicazioniBarcodeTable()});dojo.connect(b,"onKeyDown",b,function(c){c=c.keyCode?c.keyCode:c.charCode;if(c==13)this.getRowNode(this.focus.rowIndex).trigger("click");else if(c==27){$("#inputText").focus();$("#close").trigger("click")}});b=dijit.byId("pubblicazioniTableRichiediBarcode");dojo.connect(b,"onRowClick",function(){onSelectPubblicazioniRichiediBarcodeTable()});dojo.connect(b,"onKeyDown",b,function(c){c=c.keyCode?c.keyCode:c.charCode;if(c==13)this.getRowNode(this.focus.rowIndex).trigger("click");
else if(c==27){$("#inputText").focus();$("#close").trigger("click")}});dojo.connect(venditeTableObject,"onRowMouseOver",venditeTableObject,function(c){rowIndex=c.rowIndex});dojo.connect(venditeTableObject,"onKeyDown",venditeTableObject,function(c){c=c.keyCode?c.keyCode:c.charCode;if(c==46)deleteRow(this.focus.rowIndex);else c==27&&$("#inputText").focus()});$("#imgPrint, #totaleScontrino, #totalePubb, #totale").tooltip({delay:0,showURL:false});$("#ulButtons img").tooltip({delay:0,showURL:false});if($("#mostSoldBarDiv").length>
0){$("#mostSoldBarDiv").draggable({cursor:"move",cancel:".mostSoldBarImg",stop:function(c,d){mostSoldBarPos=d.position}});$("#mostSoldBarDiv").resizable({grid:[85,85],minWidth:85,minHeight:85,ghost:true,stop:function(c,d){mostSoldBarSizes=d.size}})}$("#mostSoldBarDiv").css({"z-index":99999});if(positionSizeDtoExists){$("#mostSoldBarDiv").css({position:"absolute",top:positionSizeDtoTop,left:positionSizeDtoLeft});$("#mostSoldBarDiv").width(positionSizeDtoWidth);$("#mostSoldBarDiv").height(positionSizeDtoHeight);
$("#mostSoldBarDiv").trigger("resize")}clearFileds();$("#inputText").focus()});
$(document).ready(function(){regCassaApplet=document.getElementById("regCassaApplet");$("#idCliente").css({width:$("#inputText").width()});abilitaResto=$("#abilitaResto").attr("checked");includiPubblicazioniScontrino=$("#includiPubblicazioniScontrino").length>0?$("#includiPubblicazioniScontrino").attr("checked"):false;ricercaProdottiVari=$("#ricercaProdottiVari").attr("checked");width1=screen.width>1440?"62%":"61%";width2=screen.width>1440?"80%":"79%";width3=screen.width>1440?"98%":"97%";$(document)[0].oncontextmenu=
function(){return false};showCats();var a=3;if($(window).width()<1E3)a=2;else if($(window).width()>1440)a=4;var b=Math.floor(($("#sidebarL").width()-scrollbarWidth)/a);$("#ulButtons").find("img").each(function(){$(this).css({width:b,height:b})});prodIconHeight=prodIconWidth=Math.floor(($("#sidebar").width()-scrollbarWidth)/a);$("#pneDiv").find("img").each(function(){$(this).css({width:prodIconWidth,height:prodIconHeight})});$(this).bind("keydown",handleKeyDown);$.alt("A",function(){doAzzeraConto()});
$.alt("V",function(){vendutoGiornaliero()});$.altPlus(function(){var c=isNaN($("#qta").val())?0:Number($("#qta").val());$("#qta").val(++c)},null);$.altMinus(function(){var c=isNaN($("#qta").val())?0:Number($("#qta").val());$("#qta").val(--c)},null);$("#inputText").keypress(function(c){var d=c.keyCode?c.keyCode:c.charCode;if(d==13){c.preventDefault();doInputTextEnterKeyPress()}d==27&&setModalita("CONSEGNA");if(d==37&&!c.shiftKey){c.preventDefault();$("#qta").focus()}});$("#qta").keypress(function(c){if((c.keyCode?
c.keyCode:c.charCode)==39){c.preventDefault();$("#inputText").focus()}});$("#idCliente").val(codCliente!=""?Number(codCliente):-1);$("#contoCliente").html(codCliente!=""?contoDelCliente.replace("{0}",contoCliente!=""?contoCliente:""):"");$("#estrattoConto").attr("disabled",idContoCliente!=""?false:true);$("#idCliente").change(function(){var c=$(this).val();service.getClienteConEstrattoConto(c).addCallback(function(e){clienteConEstrattoConto=e});var d=c==""||c==-1?"":contoDelCliente.replace("{0}",
$(this).find("option:selected").text());$("#contoCliente").html(d);if(c==-1){codCliente="";$("#estrattoConto").attr("disabled",true)}else{$("#estrattoConto").attr("disabled",false);codCliente=c}$("#inputText").focus()});$("#abilitaResto").change(function(){abilitaResto=$(this).attr("checked")==true?true:false;$("#inputText").focus()});$("#includiPubblicazioniScontrino").length>0&&$("#includiPubblicazioniScontrino").change(function(){includiPubblicazioniScontrino=$(this).attr("checked")==true?true:
false;$("#inputText").focus()});$("#aggiornaBarcode").attr("checked",false);$("#qta").val("1");$("#venditeIGerivCard").hide();ricercaProdottiVari&&$("#inputText").focus(function(){$(this).css("background","#ffcccc")});$(function(){$("#thumbBox").draggable();$("#popup_name").draggable({cursor:"move",cancel:"div[class*=Scroll]",cancel:"#mainDiv"});$("#dialogContent").draggable({cursor:"move",cancel:"div[class*=Scroll]"});$("#treeContiContainer").draggable({cursor:"move",cancel:"#treePlaceHolder"})});
addRightClickMenu();objMain=$("#main");objSeparator=$("#separatorR");objSeparatorL=$("#separatorL");objSeparator.click(function(c){c.preventDefault();if(objMain.hasClass("use-sidebar")){hideSidebar();$(this).tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgMostraBarraProdottiVari+"</b>"}})}else{showSidebar();$(this).tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgNascondiBarraProdottiVari+"</b>"}})}});objSeparatorL.click(function(c){c.preventDefault();if(objMain.hasClass("use-sidebar-L")){hideSidebarL();
$(this).tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgMostraBarraPubblicazioni+"</b>"}})}else{showSidebarL();$(this).tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgNascondiBarraPubblicazioni+"</b>"}})}})});function getDateFromLocalStorageItem(a){a=a.strData.split("-");return(new Date(Number(a[2]),Number(a[1])-1,Number(a[0]),0,0,0,0)).getTime()}
function getLocalDataLastKey(){for(var a=localStorage.length-1;a>=0;a--){var b=localStorage.key(a);if(b.indexOf("igeriv-")!=-1)return b}}function getLocalDataFirstItem(){for(var a=0;a<localStorage.length;a++){var b=localStorage.key(a);if(b.indexOf("igeriv-")!=-1)return JSON.parse(localStorage.getItem(b))}return null}
function loadLocalStorage(){if(useLocalStorage&&"localStorage"in window&&window.localStorage!==null){var a=getLocalDataFirstItem();a=a!=null?getDateFromLocalStorageItem(a):null;var b=(new Date).setHours(0,0,0,0);if(a==null||a!=b){block();service.getLocalDataVendite().addCallback(function(c){for(var d=0;d<c.length;d++){var e=c[d];try{localStorage.setItem("igeriv-"+e.barcode,JSON.stringify(e))}catch(f){f==QUOTA_EXCEEDED_ERR&&jConfirm(quotaExceededConfirmMsg,attenzioneMsg,function(h){if(h){localStorage.clear();
loadLocalStorage()}else{localStorage.removeItem(getLocalDataLastKey());localStorage.setItem("igeriv-"+e.barcode,JSON.stringify(e))}})}}unBlock()})}else{jConfirm(localStorageAlreadyUpdatedConfirmMsg,attenzioneMsg,function(c){if(c){localStorage.clear();loadLocalStorage()}$("#inputText").focus()},true,false);setTimeout(function(){$("#popup_cancel").focus()},200)}}}function hasClienteCondificato(){return codCliente!=""&&$("#idCliente").val()!=-1&&$("#contoCliente").html()!=""}
function doInputTextEnterKeyPress(){var a=$("#inputText").val(),b=parseLocalNum(a),c=$("#qta").val().trim();if(isNaN(c)){$.alerts.dialogClass="style_1";jAlert(moltiplicatoreInvalidoMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#qta").focus()});return false}if(isNaN(b)&&b.length<2){jAlert(ricercaMinCaratteriMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#inputText").focus()});return false}if(Number(c)>maxValueMultiplier){PlaySound("beep3");jConfirm(moltiplicatoreMoltoGrandeMsg.replace("{0}",
c),attenzioneMsg,function(d){if(d){$("#inputText").val(parseLocalNum(a));refreshDataVendite(null)}else{$("#qta").val("1");$("#inputText").focus()}})}else{b=/[a-zA-Z]/.test(a)?a:parseLocalNum(a);$("#inputText").val(b);refreshDataVendite(null)}}window.onbeforeunload=function(){if(service){service.setMostraNascodiBarreLaterali($("#sidebarL").is(":visible"),$("#sidebar").is(":visible"));if(getStoreLength(venditeTableObject)>0)return refreshMsg}};
function vendiProdottoDaBarraSceltaRapida(a,b){var c=$("#qta").val().trim();if(isNaN(c)){jAlert(moltiplicatoreInvalidoMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#qta").focus()});return false}if(Number(c)>maxValueMultiplier){PlaySound("beep3");jConfirm(moltiplicatoreMoltoGrandeMsg.replace("{0}",c),attenzioneMsg,function(d){if(d)if(a.length>0){$("#inputText").val(a);refreshDataVendite(null)}else if(b.length>0){block();service.getPubblicazioneByIdtn(b,Number(c)).addCallback(rowsCallback);
$("#inputText").focus()}else{$.alerts.dialogClass="style_1";jAlert(pubNonDisponibileMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#inputText").focus()})}else{$("#qta").val("1");$("#inputText").focus()}})}else if(a.length>0){$("#inputText").val(a);refreshDataVendite(null)}else if(b.length>0){block();service.getPubblicazioneByIdtn(b,Number(c)).addCallback(rowsCallback);$("#inputText").focus()}else{$.alerts.dialogClass="style_1";jAlert(pubNonDisponibileMsg,attenzioneMsg.toUpperCase(),
function(){$.alerts.dialogClass=null;$("#inputText").focus()})}}function showConti(){showDialog("treeContiContainer");refreshDataConti()}function showEstrattoContoCliente(){hasClienteCondificato()&&openDiv("popup_name",750,450,appContext+namespace+"/estrattoContoVenditeClientiEdicola_showFilter.action?codCliente="+codCliente+"&nomeCliente="+escape($("#idCliente").find("option:selected").text()))}function print(){getStoreLength(venditeTableObject)>0&&printReport(hasVenditeProdottiVariConIva())}
function hasVenditeProdottiVariConIva(){var a=false,b=false;for(venditeTableObject.store.fetch({query:{},onItem:function(c){if(typeof c.prodottoNonEditoriale==="undefined"||c.prodottoNonEditoriale==""?false:c.prodottoNonEditoriale=="true"?true:false)b=true},onComplete:function(){a=true}});;)if(a)break;return b}
function enableFields(){$("#totale").removeAttr("disabled");$("#totaleScontrino").removeAttr("disabled");$("#totalePubb").removeAttr("disabled");$("#contanti").removeAttr("disabled");$("#resto").removeAttr("disabled");$("#debito").removeAttr("disabled")}
function clearFileds(){$("#totalePezzi").val("");$("#totaleScontrino").val("");$("#totalePubb").val("");$("#totale").val("");$("#contanti").val("");$("#resto").val("");$("#debito").val("");$("#idConto").val("");$("#closedAccount").val("");$("#totale").attr("readonly","true");$("#totaleScontrino").attr("readonly","true");$("#totalePubb").attr("readonly","true");$("#contanti").attr("readonly","true");$("#resto").attr("readonly","true");$("#debito").attr("readonly","true");$("#inputText").removeAttr("readonly");
enableFields();$("#closedAccount").val("");setTableData(venditeTableObject,venditeTabIdField,[]);setTableData(dijit.byId("pubblicazioniTable"),pubblicazioniTabIdField,[])}function doAzzeraConto(){PlaySound("beep3");jConfirm(azzeraContoMsg,attenzioneMsg,function(a){try{if(a){refreshGiacenze();resetFields()}else $("#inputText").focus()}finally{unBlock()}})}
function refreshGiacenze(){venditeTableObject.store.fetch({query:{},onItem:function(a){var b=typeof a.idProdotto==="undefined"?0:a.idProdotto;if(typeof a.prodottoNonEditoriale==="undefined"?false:a.prodottoNonEditoriale)mapGiacenze["prod_"+b]=getLastGiacenza(b)+1}})}
function doCloseAccount(){if($("#closedAccount").val()!="true"){if($("#venditeTable tbody tr").length==0){setTimeout(function(){$.alerts.dialogClass="style_1";jAlert(nessunContoApertoMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#inputText").focus()})},200);return false}if(abilitaResto){$("#closedAccount").val("true");$("#contanti").removeAttr("readonly");$("#inputText").attr("readonly","true");enableFields();$("#contanti").focus()}else chiudiConto(false,0)}else{$("#closedAccount").val("false");
$("#contanti").val("");$("#resto").val("");$("#debito").val("");$("#contanti").attr("readonly","true");$("#inputText").removeAttr("readonly");enableFields();$("#inputText").focus()}}
function handleKeyDown(a){switch(a.keyCode?a.keyCode:a.charCode){case 32:if($("#popup_prompt").length==0&&$("#inputText").val().trim()==""){a.preventDefault();doCloseAccount()}break;case 38:case 40:a.preventDefault();a=venditeTableObject;if($("#dialogContentRicariche").is(":visible"))a=dijit.byId("ricaricheTable");else if($("#dialogContent").is(":visible"))a=dijit.byId("pubblicazioniTable");else if($("#dialogContentBarcode").is(":visible"))a=dijit.byId("pubblicazioniTableBarcode");else if($("#dialogContentRichiediBarcode").is(":visible"))a=
dijit.byId("pubblicazioniTableRichiediBarcode");a.focus.setFocusIndex(0,0)}}function verifyInputContent(){var a=parseLocalNum($("#inputText").val());if(isNaN(a)&&a.length<4)return false;return true}
$("#contanti").keydown(function(a){if((a.keyCode?a.keyCode:a.charCode)=="13"){a.preventDefault();if(($("#debito").val().indexOf(",")!=-1?parseLocalNum($("#debito").val()):$("#debito").val())>0){setTimeout(function(){$.alerts.dialogClass="style_1";jAlert(importoMinoreTotaleMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#contanti").focus()})},200);return false}PlaySound("beep3");setTimeout(function(){jConfirm(chiudiContoMsg,attenzioneMsg,function(b){b?chiudiConto(false,0):$("#inputText").focus()})},
200)}});$("#contanti").keyup(function(){var a=$(this).val().indexOf(",")!=-1?parseLocalNum($(this).val()):$(this).val();if(!isNaN(a)){var b=$("#totale").val().indexOf(",")!=-1?parseLocalNum($("#totale").val()):$("#totale").val(),c=(a-b<0?0:a-b).toFixed(2);a=(b-a<0?0:b-a).toFixed(2);$("#resto").val(displayNum(c));$("#debito").val(displayNum(a))}});
function populateTablePubblicazioni(a,b){var c=dijit.byId(b);setTableData(c,pubblicazioniTabIdField,a);$("#"+b+" tr").each(function(){$tr=$(this);$tr.css({cursor:"pointer"});$tr.mouseover(function(){$(this).addClass("highlightVendite")});$tr.mouseout(function(){$(this).removeClass("highlightVendite")})})}
var contiCallback=function(a){var b="{";b+='"identifier": "id",';b+='"label": "name",';b+='"items": [';a=a.result;if(a==null){contiTreeObject.model.store=new dojo.data.ItemFileWriteStore({data:[]});contiTreeObject.refreshModel();return false}for(var c=0,d=0;d<a.length;d++){var e=a[d],f=e.codVendita,h=e.codCliente,g=e.contoCliente,k=e.trasferitaGestionale,i=e.dataEstrattoContoFormat,m=e.dataVenditaFormat,n=displayNum(e.sommaVenduto.toFixed(2)),l=e.idScontrino,o=e.fatturaEmessa,q=e.fatturaContoUnico,
r=e.numeroFattura;m=m+" (&#8364;&nbsp;"+n+")";if(d>0&&d<a.length)b+=",";b+='{ "type": "parent", "name": "'+m+'", "id": "parent'+d+'"';b+=',"codVendita": "'+f+'","numeroFattura": "'+r+'","fatturaContoUnico": "'+q+'","fatturaEmessa": "'+o+'","idScontrino": "'+l+'", "codCliente": "'+h+'", "trasferitaGestionale": "'+k+'", "dataEstrattoConto": "'+i+'", "contoCliente": "'+g+'"';b+=e.listVenditaDettaglio.length>0?',"children":[':"}";for(f=0;f<e.listVenditaDettaglio.length;f++){var j=e.listVenditaDettaglio[f];
h=j.progressivo!=null?j.progressivo:"";g=j.prodottoNonEditoriale;k=j.idProdotto!=null?j.idProdotto:"";i=j.barcode!=null?j.barcode:"";l=j.quantita!=null?j.quantita:"";o=j.idtn!=null?j.idtn:"";q=j.codFiegDl!=null?j.codFiegDl:"";r=j.prezzoCopertina!=null?j.prezzoCopertina:"";m=j.dataUscita!=null?j.dataUscita:"";n=j.titolo!=null?j.titolo:"";var u=j.sottoTitolo!=null?j.sottoTitolo:"",s=j.numeroCopertina!=null?j.numeroCopertina:"",v=j.giacenzaIniziale!=null?j.giacenzaIniziale:"",w=typeof j.aliquota!=="undefined"&&
j.aliquota!=null?j.aliquota:"",t=j.prezzoCopertina.toFixed(2);j=j.importoTotale.toFixed(2);t=displayNum(t);j=displayNum(j);var p=n+(s!=""?"&nbsp;("+s.trim()+")":"")+"&nbsp;&#8364;&nbsp;"+j;if(f>0&&f<e.listVenditaDettaglio.length)b+=",";b+='{"type":"Leaf", "name": "'+p+'", "id":"child'+c++ +'"';b+=', "progressivo": "'+h+'"';b+=', "prodottoNonEditoriale": "'+g+'"';b+=', "idProdotto": "'+k+'"';b+=', "barcode": "'+i+'"';b+=', "quantita": "'+l+'"';b+=', "titolo": "'+n+'"';b+=', "sottoTitolo": "'+u+'"';
b+=', "numeroCopertina": "'+s+'"';b+=', "prezzoCopertina": "'+r+'"';b+=', "prezzoCopertinaFormat": "'+t+'"';b+=', "importoFormat": "'+j+'"';b+=', "dataUscita": "'+m+'"';b+=', "codFiegDl": "'+q+'"';b+=', "giacenzaIniziale": "'+v+'"';b+=', "idtn": "'+o+'"';b+=', "aliquota": "'+w+'"';b+="}"}if(e.listVenditaDettaglio.length>0)b+="]";b+="}"}b+="]}";treeDat=jQuery.parseJSON(b);b=new dojo.data.ItemFileWriteStore({data:treeDat});contiTreeObject.model.store=b;contiTreeObject.model.query={type:"parent"};contiTreeObject.rootId=
"root";contiTreeObject.rootLabel="Groups";contiTreeObject.childrenAttrs=["children"];contiTreeObject.refreshModel()};
function treeDoubleClick(a){var b=a.trasferitaGestionale,c=a.dataEstrattoConto.toString().length>0?true:false,d=a.idScontrino.toString(),e=a.fatturaEmessa.toString(),f=a.fatturaContoUnico.toString(),h=a.numeroFattura.toString();if(c){$.alerts.dialogClass="style_1";jAlert(impossibileEditareEstrattoContoChiusoMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null});setTimeout(function(){$("#popup_ok").focus()},100);return false}else if(isNaN(b)||Number(b)>0){$.alerts.dialogClass="style_1";
jAlert(impossibileEditareMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null});setTimeout(function(){$("#popup_ok").focus()},100);return false}else if(e=="true"&&f=="false"){$.alerts.dialogClass="style_1";jAlert(impossibileEditareContoInFatturaEmessaMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null});setTimeout(function(){$("#popup_ok").focus()},100);return false}else if(d.length>0&&d!="null"){jConfirm(msgConfirmStornoManualeRicevutaFiscale,attenzioneMsg,function(g){if(g)dblClickDeleteConto(a);
else return false},true,false);return false}else if(e=="true"&&f=="true"){jConfirm(msgConfirmStornoManualeFattura,attenzioneMsg,function(g){if(g)dblClickDeleteConto(a,function(){doPrintFattura(a.codCliente,false,STORNO_FATTURA,null,h)});else return false},true,false);return false}else dblClickDeleteConto(a)}
function dblClickDeleteConto(a,b){var c=a.codVendita;codCliente=a.codCliente;$("#contoCliente").html(typeof a.contoCliente!=="undefined"?htmlEncode(a.contoCliente.toString()):"");$("#idConto").val(c);service.deleteConto(Number(c)).addCallback(function(d){if(d.type=="EXCEPTION"){$.alerts.dialogClass="style_1";jAlert(d.exceptionMessage,attenzioneMsg.toUpperCase(),function(){unBlockUI();$.alerts.dialogClass=null})}else{d=d.result;for(var e=a.children,f="[",h={},g={},k=0;k<e.length;k++){var i=e[k],m=
i.progressivo,n=i.prodottoNonEditoriale,l=i.idProdotto,o=i.barcode.toString(),q=i.titolo.toString(),r=i.quantita,j=i.sottoTitolo.toString(),u=i.numeroCopertina.toString(),s=i.prezzoCopertinaFormat.toString(),v=i.importoFormat.toString(),w=i.prezzoCopertina,t=i.dataUscita,p=i.idtn,y=i.aliquota;h[p]=typeof h[p]==="undefined"?1:Number(h[p])+1;g[l]=typeof g[l]==="undefined"?1:Number(g[l])+1;var x=typeof n!=="undefined"&&n.toString()=="true"?true:false;if(x)if(g[l]==1)mapGiacenze["prod_"+l]=d["pne_"+l];
var z=x?mapGiacenze["prod_"+l]:d["pub_"+p]-h[p];if(x)mapGiacenze["prod_"+l]=getLastGiacenza(l)-1;i=i.codFiegDl;if(k>0&&k<e.length)f+=",";f+='{"progressivo":"'+m+'","prodottoNonEditoriale":"'+n+'","idProdotto":"'+l+'","barcode":"'+o+'","quantita":"'+r+'","titolo":"'+q.replace(/\&#8364;/g,"\u20ac")+'","sottoTitolo":"'+j.replace(/\&#8364;/g,"\u20ac")+'","numeroCopertina":"'+u+'","prezzoCopertina":"'+w+'","prezzoCopertinaFormat":"'+s+'","importoFormat":"'+v+'","dataUscita":"'+t+'","coddl":"'+i+'","giacenzaIniziale":"'+
z+'","aliquota":"'+y+'","idtn":"'+p+'"}'}f+="]";pubblicazioniJSON=jQuery.parseJSON(f);setTableData(venditeTableObject,venditeTabIdField,pubblicazioniJSON);setTotals();setTimeout(function(){$("#idCliente").val(codCliente!=""?Number(codCliente):-1);setScrollBarToBottom();addRightClickMenu();$("#inputText").val("");$("#inputText").focus();typeof b==="function"&&b()},100);$("#close").trigger("click")}})}function block(){blockVenditaUntillCallback&&ray.ajax()}
function unBlock(){unBlockUI();unBlockInputText()}
var rowsCallback=function(a){try{if(a.type=="EXCEPTION"){$.alerts.dialogClass="style_1";jAlert(a.exceptionMessage,attenzioneMsg.toUpperCase(),function(){unBlock();$.alerts.dialogClass=null;$("#inputText").val("");$("#inputText").focus()})}else if(a.type=="CONFIRM_ASSOCIA_BARCODE"||a.type=="CONFIRM_INVIA_MESSAGGIO_ASSOCIA_BARCODE"){doAssociaBarcode(a);unBlock()}else if(a.type=="CONFIRM_ABILITARE_IGERIV_CARD"){doAssociaIGerivCard(a);unBlock()}else{if(a.type=="VENDITE_TITOLO"){showDialog("dialogContent");
populateTablePubblicazioni(a.result,"pubblicazioniTable");$("#inputText").blur();document.getElementById("inputText").value="";unBlock()}else if(a.type=="VENDITE_PREZZO"){addTableData(venditeTableObject,venditeTabIdField,a.result);document.getElementById("inputText").value="";$("#qta").val(1);unBlock()}else if(a.type=="VENDITE_BARCODE")if($("#aggiornaBarcode").is(":checked")){a.exceptionMessage=abilitataCorrezioneBarcode=="true"?msgConfirmAggiornareAssociazioneBarcode:msgConfirmRichiestaAggiornareAssociazioneBarcode;
a.type=abilitataCorrezioneBarcode=="true"?"CONFIRM_ASSOCIA_BARCODE":"CONFIRM_INVIA_MESSAGGIO_ASSOCIA_BARCODE";doAssociaBarcode(a);unBlock()}else if(typeof a.result!="undefined"&&a.result.prodottoNonEditoriale){var b=getLastGiacenza(a.result.idProdotto);if(b<=0){PlaySound("beep3");jConfirm(msgProdottoSenzaGiacenza.replace("{0}",a.result.titolo),attenzioneMsg,function(c){if(c){a.result.giacenzaIniziale=b;addSearchRowToTable(a.result);document.getElementById("inputText").value="";mapGiacenze["prod_"+
a.result.idProdotto]=b-1}else return false;unBlock()})}else{a.result.giacenzaIniziale=b;addSearchRowToTable(a.result);document.getElementById("inputText").value="";mapGiacenze["prod_"+a.result.idProdotto]=b-1;unBlock()}}else{a.result.progressivo=getProgressivo(venditeTableObject);addSearchRowToTable(a.result);document.getElementById("inputText").value="";unBlock()}else if(a.type=="VENDITE_IDTN"){if(a.result==null||a.result.length==0){$.alerts.dialogClass="style_1";jAlert(pubNonDisponibileMsg,attenzioneMsg.toUpperCase(),
function(){$.alerts.dialogClass=null});unBlock();$("#inputText").focus();return false}a.result.progressivo=getProgressivo(venditeTableObject);addTableData(venditeTableObject,venditeTabIdField,a.result);document.getElementById("inputText").value="";$("#qta").val(1);unBlock()}else if(a.type=="VENDITE_ABBONAMENTO"){jAlert(a.exceptionMessage,alertInfoMsg,function(){$("#inputText").val("");setModalita("CONSEGNA")});unBlock()}else if(a.type=="VENDITE_IGERIV_CARD"){$("#contoCliente").html(a.result.contoNome);
showDivVenditeIGerivCard(a);codCliente=a.result.codCliente;$("#idCliente").val(Number(codCliente));$("#inputText").val("");unBlock();$("#inputText").focus()}else if(a.type=="RICARICA_MINICARD")jAlert(a.exceptionMessage,alertInfoMsg,function(){$("#inputText").val("");unBlock();setModalita("CONSEGNA")});else if(a.type=="STATO_MINICARD")jAlert(a.exceptionMessage,alertInfoMsg,function(){$("#inputText").val("");unBlock();setModalita("CONSEGNA")});else if(a.type=="PUBBLICAZIONI_MULTIPLE"){showDialogProdotti(a.message);
unBlock()}else if(a.type=="CONFIRM_ESEGUI_RICARICA"){showConfirmEseguiRicarica(a);unBlock()}else if(a.type=="GESTIONE_ARRETRATI"){showDialogGestioneArretrati(a.message);unBlock()}else if(a.type=="VENDUTO_GIORNALIERO"){jAlert(a.result,informazioneMsg,function(){$("#inputText").val("");unBlock();$("#inputText").focus()});document.getElementById("inputText").value=""}else if(a.type=="VENDUTO_CONTO"){setTableData(venditeTableObject,venditeTabIdField,a.result);$("#idConto").val(a.codVendita);document.getElementById("inputText").value=
"";unBlock()}else if(a.type=="CONTO_CHIUSO"){resetFields();unBlock();$("#inputText").focus()}addRightClickMenu()}}finally{unBlock();dataScontrino=idScontrino=""}};function resetFields(){clearFileds();$("#totalePezzi").val("");$("#inputText").val("");codCliente="";$("#idCliente").val(-1);$("#estrattoConto").attr("disabled",true);$("#contoCliente").html("");$("#inputText").focus()}
function getProgressivo(a){var b=0,c=0;a.store.fetch({query:{},onItem:function(d){b=Number(d.progressivo);if(b>c)c=b}});return Number(c)+1}
function showDivVenditeIGerivCard(a){$("#venditeIGerivCard").show();var b="",c=a.result.ultimiAcquisti;if(c!=null)for(var d=0;d<c.length;d++){var e=c[d],f=e.titolo!=null&&e.titolo.trim().length>0?e.titolo.trim():"&nbsp;",h=e.sottoTitolo!=null&&e.sottoTitolo.trim().length>0?e.sottoTitolo.trim():"&nbsp;";e=e.numeroCopertina!=null&&e.numeroCopertina.trim().length>0?e.numeroCopertina.trim():"&nbsp;";var g=d%2==0?"#fdecae;":"#FDB5AE;";b+='<span style="float:left; width:45%; white-space:nowrap; font-size:90%; background-color: '+
g+'">'+f+'</span><span style="float:left; width:30%; white-space:nowrap; font-size:90%; font-size:90%; background-color: '+g+'">'+h+'</span><span style="float:left; width:8%; white-space:nowrap; font-size:90%; background-color: '+g+'">'+numMsg+'</span><span style="float:left; width:17%; white-space:nowrap; font-size:90%; background-color: '+g+'">'+e+"</span>"}var k="";a=a.result.suggerimentiVendita;if(a!=null)for(d=0;d<a.length;d++){e=c[d];f=e.titolo!=null?e.titolo:"&nbsp;";h=e.sottoTitolo!=null?
e.sottoTitolo:"&nbsp;";e=e.numeroCopertina!=null?e.numeroCopertina:"&nbsp;";g=d%2==0?"#fdecae;":"#FDB5AE;";k+='<span style="float:left; width:45%; white-space:nowrap; font-size:90%; background-color: '+g+'">'+f+'</span><span style="float:left; width:30%; white-space:nowrap; font-size:90%; font-size:90%; background-color: '+g+'">'+h+'</span><span style="float:left; width:8%; white-space:nowrap; font-size:90%; background-color: '+g+'">'+numMsg+'</span><span style="float:left; width:17%; white-space:nowrap; font-size:90%; background-color: '+
g+'">'+e+"</span>"}$("#preferiti").html(b);$("#suggerimenti").html(k);$("#venditeIGerivCard").dialog({autoOpen:false,title:smartCardEdicola,closeText:chiudiLabel,height:"380"});$("#venditeIGerivCard").dialog("open")}
function doAssociaIGerivCard(a){PlaySound("beep3");jConfirm(a.exceptionMessage,attenzioneMsg,function(){setTimeout(function(){jPromptSmartEdicola(scegliClienteMsg,msgIGerivCard,clientiEdicola,function(b){if(hasClienteCondificato())service.associaIGerivCard($("#inputText").val(),b,"false").addCallback(associateCallback);else{$("#inputText").val("");$("#inputText").focus();return false}})},100)})}
function associateCallback(a){if(a.type=="EXCEPTION"){$.alerts.dialogClass="style_1";jAlert(a.exceptionMessage,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#inputText").val("");return false})}else a.type=="CONFIRM_RIASSOCIARE_IGERIV_CARD"?setTimeout(function(){jConfirm(a.exceptionMessage,attenzioneMsg,function(b){if(b)service.associaIGerivCard($("#inputText").val(),codCliente,"true").addCallback(associateCallback);else return false})},100):jAlert(a.result,informazioneMsg,function(){$("#contoCliente").html(a.contoNome);
codCliente=a.codCliente;$("#inputText").val("");return false})}
function doAssociaBarcode(a){PlaySound("beep3");jConfirm(a.exceptionMessage,attenzioneMsg,function(b){if(b)setTimeout(function(){jPrompt(msgInserisciTitolo,null,msgAggiornamentoBarcode,function(c){if(c!=null&&c.length>0){c={inputText:c,soloPubblicazioniBarcodeNullo:true,progressivo:getProgressivo(venditeTableObject),mostraTutteUscite:false};service.getRows(c).addCallback(function(d){if(d.type=="EXCEPTION"){$.alerts.dialogClass="style_1";jAlert(d.exceptionMessage,attenzioneMsg.toUpperCase(),function(){unBlock();
$.alerts.dialogClass=null;$("#inputText").val("");$("#inputText").focus()})}else{showDialog(a.type=="CONFIRM_ASSOCIA_BARCODE"?"dialogContentBarcode":"dialogContentRichiediBarcode");populateTablePubblicazioni(d.result,a.type=="CONFIRM_ASSOCIA_BARCODE"?"pubblicazioniTableBarcode":"pubblicazioniTableRichiediBarcode")}})}})},100);else{$("#inputText").val("");$("#inputText").focus();return false}},true,false)}
refreshDataVendite=function(a){block();var b=document.getElementById("inputText").value;if(b==barcodeFinalizza)chiudiConto(false,0);else{var c=useLocalStorage&&"localStorage"in window&&window.localStorage!==null?localStorage.getItem("igeriv-"+b):null;if(c!==null){a=$("#qta").val();if(isNaN(a)){jAlert(moltiplicatoreInvalidoMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#qta").focus()});return false}c=JSON.parse(c);c.progressivo=getProgressivo(venditeTableObject);c.quantita=
Number(a);c.prodottoNonEditoriale="false";c.importo=c.quantita*Number(c.prezzoCopertina);c.importoFormat=displayNum(c.importo.toFixed(2));c.giacenzaIniziale="-";addSearchRowToTable(c);unBlock()}else{c={inputText:b,progressivo:getProgressivo(venditeTableObject),idConto:a,operation:modalita,quantita:Number($("#qta").val().trim()),mostraTutteUscite:$("#mostraTutteUscite").is(":checked"),ricercaProdottiVari:ricercaProdottiVari};service.getRows(c).addCallback(rowsCallback)}}};refreshDataConti=function(){service.getConti().addCallback(contiCallback)};
vendutoGiornaliero=function(){service.getVendutoGiornaliero().addCallback(rowsCallback)};
printReport=function(a){a&&codCliente!=""?jRadio(msgScegliTipoDocumento,msgTipoDocumento,"tipoDocumento",registratoreCassa!=""&&registratoreCassa>0?clienteConEstrattoConto?[bollettinaConsegna,ricevutaFiscale]:[bollettinaConsegna,ricevutaFiscale,fattura]:clienteConEstrattoConto?[bollettinaConsegna]:[bollettinaConsegna,fattura],registratoreCassa!=""&&registratoreCassa>0?clienteConEstrattoConto?[BOLLETTINA_CONSEGNA,RICEVUTA_FISCALE]:[BOLLETTINA_CONSEGNA,RICEVUTA_FISCALE,FATTURA]:clienteConEstrattoConto?
[BOLLETTINA_CONSEGNA]:[BOLLETTINA_CONSEGNA,FATTURA],function(b){if(b!="")switch(Number(b)){case RICEVUTA_FISCALE:printRicevutaFiscale();break;case FATTURA:printFattura();break;case BOLLETTINA_CONSEGNA:printBollettinaConsegna()}}):printBollettinaConsegna()};function printRicevutaFiscale(){var a=getJsonStoreString(venditeTableObject);regCassaApplet.emettiScontrino(a,dojo.toJson(arrAliquoteReparti),clienteConEstrattoConto.toString())}
function printRicevutaFiscaleCallback(a,b){unBlockInputText();jAlert(msgRicevutaEmessa,informazioneMsg,function(){idScontrino=b;dataScontrino=a;jConfirm(msgConfirmStampareBollettinaConsegna,attenzioneMsg,function(c){if(c)printBollettinaConsegna(function(){chiudiConto(true,0)});else{chiudiConto(true,0);$("#inputText").focus()}},true,true);return false})}
function alertMissingRegCassaActiveProcess(){unBlockInputText();$.alerts.dialogClass="style_1";jAlert(msgMissingRegCassaActiveProcess,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;return false})}
function showAlertRepartiRegCassa(a){if(!msgRepartiRegistratoreCassaVisto){$.alerts.dialogClass="style_1";jConfirmWithCheckboxCallback(a,attenzioneMsg.toUpperCase(),function(b){$.alerts.dialogClass=null;if(b)regCassaApplet.initRegCassa();else{regCassaApplet.stop();service.deleteParamRegCassa().addCallback(function(){window.location.href=appContext+"/vendite_showFilter.action"})}},msgNonVisualizzarePiuMessaggio,function(){service.setMessaggioRegCassaVisto(codRegCassa)});setTimeout(function(){$("#popup_ok").focus()},
100)}return false}function alertUnsupportedOS(){unBlockInputText();$.alerts.dialogClass="style_1";jAlert(unsupportedOS,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;return false})}
function promptForRegCassaLocalInstallPath(){unBlockInputText();jPrompt(msgConfirmRegCassaInstallPath,null,msgRegCassaInstallPath,function(a){a!=null&&a.length>0&&service.setUserRegCassaLocalDir(a).addCallback(function(b){if(b.toString()=="true")regCassaApplet.setUserRegCassaLocalDir(a);else{$.alerts.dialogClass="style_1";jAlert(msgErrorUpdateRegCassaInstallPath,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#inputText").val("");return false})}})});setTimeout(function(){$("#popup_prompt").focus()},
200)}
function promptForRegCassaScontriniPath(){unBlockInputText();jPrompt(msgConfirmRegCassaScontriniPath,null,msgRegCassaScontriniPath,function(a){a!=null&&a.length>0&&service.setUserRegCassaLocalDir(a).addCallback(function(b){if(b.toString()=="true")regCassaApplet.setScontriniRegCassaLocalDir(a);else{$.alerts.dialogClass="style_1";jAlert(msgErrorUpdateRegCassaInstallPath,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#inputText").val("");return false})}})});setTimeout(function(){$("#popup_prompt").focus()},200)}
function printFattura(){service.validateDatiFiscaliCliente(codCliente).addCallback(function(a){a!=""?jConfirm(a,attenzioneMsg,function(b){if(b)openDiv("popup_name",900,400,"gestioneClienti_showCliente.action?idCliente="+codCliente,"","","",function(){clienteEdicolaSuccessCallback=function(){unBlockUI();doCloseLayer();doPrintFattura(codCliente,false,FATTURA,function(){afterPrintFatturaCallback()})};validateFieldsClienteEdicola=function(){if(validateFieldsClienteBase(true)){if($("#tipoLocalita").val()==
""){$.alerts.dialogClass="style_1";jAlert(campoObbligatorio.replace("{0}",indirizzo),attenzioneMsg,function(){$.alerts.dialogClass=null;$("#tipoLocalita").focus()});unBlockUI();return false}if($("#cliente\\.numeroCivico").val()==""){$.alerts.dialogClass="style_1";jAlert(campoObbligatorio.replace("{0}",numCivicoLabel),attenzioneMsg,function(){$.alerts.dialogClass=null;$("#cliente\\.numeroCivico").focus()});unBlockUI();return false}if($("#autocomplete").val()==""){$.alerts.dialogClass="style_1";jAlert(campoObbligatorio.replace("{0}",
localita),attenzioneMsg,function(){$.alerts.dialogClass=null;$("#autocomplete").focus()});unBlockUI();return false}if($("#cliente\\.codiceFiscale").val()==""&&$("#cliente\\.piva").val()==""){$.alerts.dialogClass="style_1";jAlert(campoObbligatorio.replace("{0}",codFiscale+" / "+piva),attenzioneMsg,function(){$.alerts.dialogClass=null;$("#cliente\\.codiceFiscale").focus()});unBlockUI();return false}return true}else return false}});else{$("#inputText").val("");$("#inputText").focus()}return false}):
doPrintFattura(codCliente,true,FATTURA,function(){afterPrintFatturaCallback()})})}
function doPrintFattura(a,b,c,d,e){blockUIForDownload($(this));populateReportVenditeForm();a='<input type="hidden" name="codCliente" value="'+a+'"/>';var f='<input type="hidden" name="tipoDocumento" value="'+c+'"/>';if(c==STORNO_FATTURA&&typeof e!=="undefined"&&e!=""&&e>0){c='<input type="hidden" name="numFattura" value="'+e+'"/>';$("#ReportVenditeForm").append(c)}$("#ReportVenditeForm").append(a);$("#ReportVenditeForm").append(f);$("#ReportVenditeForm").attr("target","_blank");$("#ReportVenditeForm").submit();
b==false&&unBlockUI();typeof d==="function"&&d()}function afterPrintFatturaCallback(){jConfirm(msgConfirmStampareBollettinaConsegna,attenzioneMsg,function(a){service.getLastNumFatturaEmessaDaUtente().addCallback(function(b){if(a)printBollettinaConsegna(function(){chiudiConto(true,b)});else{chiudiConto(true,b);$("#inputText").focus()}})},true,true)}
function printBollettinaConsegna(a){var b=typeof a==="function"?true:false,c=function(d){var e=hasClienteCondificato(),f=typeof d!=="undefined"&&d.length!="null";if(!e&&!f){b||chiudiConto(true,0);return false}blockUIForDownload($(this));populateReportVenditeForm();if(e){d='<input type="hidden" name="codCliente" value="'+codCliente+'"/>';$("#ReportVenditeForm").append(d)}else if(f){d='<input type="hidden" name="ragSocCliente" value="'+d+'"/>';$("#ReportVenditeForm").append(d)}d='<input type="hidden" name="tipoDocumento" value="'+
BOLLETTINA_CONSEGNA+'"/>';$("#ReportVenditeForm").append(d);$("#ReportVenditeForm").attr("target","_blank");$("#ReportVenditeForm").submit();b&&a()};hasClienteCondificato()?c():jPrompt(ragSocialeClienteIndirizzoDatiFiscali,"",datiCliente,c,true,4,60)}
function populateReportVenditeForm(){var a=$("#downloadToken").val()==""?(new Date).getTime():$("#downloadToken").val();$("#ReportVenditeForm").empty();var b=false,c=false,d=0;venditeTableObject.store.fetch({query:{},onItem:function(e){var f=e.progressivo,h=e.idtn,g=e.prezzoCopertina,k=e.titolo.toString(),i=e.sottoTitolo.toString(),m=typeof e.dataUscitaFormat!=="undefined"?e.dataUscitaFormat.toString():"",n=typeof e.prodottoNonEditoriale==="undefined"?false:e.prodottoNonEditoriale=="true"?true:false,
l=e.numeroCopertina,o=typeof e.aliquota==="undefined"||e.aliquota==""?0:Number(e.aliquota);f='<input type="hidden" name="vendite['+d+'].progressivo" value="'+f+'"/>';h='<input type="hidden" name="vendite['+d+'].idtn" value="'+h+'"/>';g='<input type="hidden" name="vendite['+d+'].importo" value="'+g+'"/>';e='<input type="hidden" name="vendite['+d+'].copie" value="'+e.quantita+'"/>';m='<input type="hidden" name="vendite['+d+'].dataUscita" value="'+m+'"/>';k='<input type="hidden" name="vendite['+d+'].titolo" id="tit'+
d+'" value="'+k.replace(/\&#8364;/g,"Euro").replace(/\u20ac/g,"Euro")+'"/>';i='<input type="hidden" name="vendite['+d+'].sottoTitolo" value="'+i.replace(/\&#8364;/g,"Euro").replace(/\u20ac/g,"Euro")+'"/>';l='<input type="hidden" name="vendite['+d+'].numeroCopertina" value="'+l+'"/>';var q='<input type="hidden" name="vendite['+d+'].aliquota" value="'+o+'"/>',r='<input type="hidden" name="vendite['+d+'].prodottoNonEditoriale" value="'+n+'"/>';b=n&&o>0?true:b;c=o==0?true:c;$("#ReportVenditeForm").append(f);
$("#ReportVenditeForm").append(h);$("#ReportVenditeForm").append(g);$("#ReportVenditeForm").append(e);$("#ReportVenditeForm").append(k);$("#ReportVenditeForm").append(i);$("#ReportVenditeForm").append(m);$("#ReportVenditeForm").append(l);$("#ReportVenditeForm").append(q);$("#ReportVenditeForm").append(r);$("#ReportVenditeForm").append('<input type="hidden" name="vendite['+d+'].codCliente" value="'+codCliente+'"/>');d++}});$("#ReportVenditeForm").append('<input type="hidden" name="downloadToken" id="downloadToken" value="'+
a+'"/>');$("#ReportVenditeForm").append('<input type="hidden" name="hasProdottiMisti" value="'+(b&&c)+'"/>')}function blockInputText(){$("#inputText").attr("disabled",true)}function unBlockInputText(){$("#inputText").attr("disabled",false)}
function chiudiConto(a,b){if(getStoreLength(venditeTableObject)>0){blockInputText();ray.ajax()}(typeof a==="undefined"?true:a)==false&&hasRegistratoreCassa==true&&(hasVenditeProdottiVariConIva()||includiPubblicazioniScontrino==true)?printRicevutaFiscale():doChiudiConto(b)}function doChiudiConto(a){hasClienteCondificato()?setTimeout(function(){clienteConEstrattoConto?executeChiudiConto(false,a):executeChiudiConto(true,a);$("#inputText").focus()},200):executeChiudiConto(true,a)}
function executeChiudiConto(a,b){var c=typeof b!=="undefined"&&b>0?b:0,d=[];venditeTableObject.store.fetch({query:{},onItem:function(e){var f=e.progressivo.toString(),h=e.idtn.toString(),g=e.prezzoCopertina.toString(),k=e.titolo.toString(),i=e.sottoTitolo.toString(),m=e.numeroCopertina.toString(),n=Number(e.quantita),l=isNaN(e.coddl)?0:Number(e.coddl);d.push({prodottoNonEditoriale:typeof e.prodottoNonEditoriale==="undefined"?false:e.prodottoNonEditoriale=="true"?true:false,progressivo:f,idtn:h,codProdottoNonEditoriale:typeof e.idProdotto===
"undefined"?0:Number(e.idProdotto),importo:g,titolo:k,sottoTitolo:i,numeroCopertina:m,quantita:n,codFiegDlPubblicazione:l})}});setTimeout(function(){if(getStoreLength(venditeTableObject)>0){block();service.chiudiConto(d,$("#idConto").val(),typeof codCliente==="undefined"||codCliente==""?null:Number(codCliente),parseLocalNum($("#totale").val()),parseLocalNum($("#totaleScontrino").val()),includiPubblicazioniScontrino.toString(),a.toString(),idScontrino,dataScontrino,c).addCallback(rowsCallback)}},100)}
onSelectPubblicazioniTable=function(){var a=dijit.byId("pubblicazioniTable"),b=a.getItem(a.focus.rowIndex),c=typeof b.prodottoNonEditoriale!=="undefined"&&b.prodottoNonEditoriale.toString()=="true";a.store.setValue(b,"progressivo",getProgressivo(venditeTableObject));if(c){c=itemToJSON(a.store,b);var d=dojo.fromJson(c),e=getLastGiacenza(b.idProdotto);if(e<=0){PlaySound("beep3");jConfirm(msgProdottoSenzaGiacenza.replace("{0}",b.titolo),attenzioneMsg,function(f){if(f){d.giacenzaIniziale=e;addSearchRowToTable(d);
mapGiacenze["prod_"+b.idProdotto]=e-1}else{$("#close").trigger("click");return false}})}else{d.giacenzaIniziale=e;addSearchRowToTable(d);mapGiacenze["prod_"+b.idProdotto]=e-1}}else service.getGiacenzaPubblicazione(Number(b.idtn),Number(b.coddl)).addCallback(function(f){a.store.setValue(b,"giacenzaIniziale",Number(f));f=itemToJSON(a.store,b);f=dojo.fromJson(f);addSearchRowToTable(f)})};
onSelectPubblicazioniBarcodeTable=function(){var a=dijit.byId("pubblicazioniTableBarcode"),b=a.getItem(a.focus.rowIndex);jConfirm(msgConfirmAssociazioneBarcode.replace("{0}",$("#inputText").val()).replace("{1}",b.titolo).replace("{2}",b.numeroCopertina).replace("{3}",b.dataUscitaFormat),attenzioneMsg,function(c){if(c)service.associaBarcodePubblicazione(Number(b.idtn),Number(b.coddl),$("#inputText").val().toString()).addCallback(function(d){if(d.type=="EXCEPTION"){$.alerts.dialogClass="style_1";jAlert(d.result,
attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#inputText").val("");$("#close").trigger("click");return false})}else d.type=="CONFIRM_INVIA_MESSAGGIO_ASSOCIA_BARCODE"?doAssociaBarcode(d):jAlert(d.result,informazioneMsg,function(){$("#aggiornaBarcode").attr("checked",false);doInputTextEnterKeyPress();$("#close").trigger("click");return false})});else{$("#inputText").val("");$("#close").trigger("click");return false}})};
onSelectPubblicazioniRichiediBarcodeTable=function(){var a=dijit.byId("pubblicazioniTableRichiediBarcode"),b=a.getItem(a.focus.rowIndex);jConfirm(msgConfirmInviaRichiestaAssociazioneBarcode.replace("{0}",$("#inputText").val()).replace("{1}",b.titolo).replace("{2}",b.numeroCopertina).replace("{3}",b.dataUscitaFormat),attenzioneMsg,function(c){if(c)service.sendRequestAggiornaBarcode(Number(b.idtn),Number(b.coddl),$("#inputText").val().toString()).addCallback(function(d){if(d.type=="EXCEPTION"){$.alerts.dialogClass=
"style_1";jAlert(d.result,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null})}else jAlert(d.result,informazioneMsg,function(){return false});$("#inputText").val("");$("#close").trigger("click");return false});else{$("#inputText").val("");$("#close").trigger("click");return false}})};function addSearchRowToTable(a){addTableData(venditeTableObject,venditeTabIdField,a);$("#qta").val(1);$("#close").length>0&&$("#close").trigger("click");$("#inputText").focus()}
function onCloseLayer(){$("#inputText").focus()}
function deleteRow(a){var b=venditeTableObject.getItem(a),c=b.titolo,d=b.idProdotto,e=b.prodottoNonEditoriale;cancellaVenditaConfirmMsg=cancellaVenditaConfirmMsg.replace("{0}",'"'+c+'"');PlaySound("beep3");jConfirm(cancellaVenditaConfirmMsg,attenzioneMsg,function(f){cancellaVenditaConfirmMsg=cancellaVenditaConfirmMsg.replace('"'+c+'"',"{0}");if(f){if(e)mapGiacenze["prod_"+d]=getLastGiacenza(d)+1;venditeTableObject.store.deleteItem(b)}else $("#inputText").focus()})}
function addRightClickMenu(){$("#venditeDiv .dojoxGridScrollbox table tbody tr").find("td").contextMenu({menu:"myMenu",xLeft:0},function(a,b,c){rightContextMenuWork(a,b,c)});$("#finalizza").contextMenu({menu:"barcodeMenu",xLeft:0},function(){window.open("/pdf/barcode_finalizza.pdf","_blank");return false});$(".openmenu").contextMenu({menu:"myMenu",leftButton:true},function(a,b,c){rightContextMenuWork(a,b.parent("tr"),c)})}function rightContextMenuWork(a){var b=rowIndex;a=="delete"&&deleteRow(b)}
function setScrollBarToBottom(){$(".dojoxGridScrollbox").attr({scrollTop:$(".dojoxGridScrollbox").attr("scrollHeight")})}var rechargesCallback=function(a){showDialog("dialogContentRicariche");populateTableRicariche(a.ricariche);unBlock()};
function populateTableRicariche(a){var b=dijit.byId("ricaricheTable");addTableData(b,ricaricheTabIdField,a);$("#ricaricheTable tr").each(function(){$(this).mouseover(function(){$(this).addClass("highlightVendite")});$(this).mouseout(function(){$(this).removeClass("highlightVendite")})})}function showDialogProdotti(a){jPrompt(a,null,insertBarcodeMsg,function(b){b?refreshRitiriProdotto(b):$("#inputText").val("")})}
refreshRicariche=function(a,b){var c={inputText:document.getElementById("inputText").value,idEditore:a,idProdotto:b,operation:"TIPOLOGIE_MINICARD"};service.getRows(c).addCallback(rechargesCallback)};refreshRitiriProdotto=function(a){a={inputText:document.getElementById("inputText").value,barcode:a,operation:modalita,quantita:Number($("#qta").val().trim())};service.getRows(a).addCallback(rowsCallback)};function showDialogRicariche(a,b,c){refreshRicariche(b,c)}
function showConfirmEseguiRicarica(a){if(a.exceptionMessage!=null&&a.exceptionMessage.length>0){PlaySound("beep3");jConfirm(a.exceptionMessage,cardRechargeMsg,function(b){if(b){selectedBarcode=a.barcode;showDialogRicariche(availableRechargesMsg,a.idEditore,a.idProdotto)}else{$("#inputText").val("");setModalita("CONSEGNA")}})}else{selectedBarcode=a.barcode;showDialogRicariche(availableRechargesMsg,a.idEditore,a.idProdotto)}}
function showDialogGestioneArretrati(a){PlaySound("beep3");jConfirm(a,manageBackMsg,function(b){b&&showDialogProdotti(insertBackMsg)})}
onSelectRicaricheTable=function(){var a=dijit.byId("ricaricheTable");a=a.getItem(a.focus.rowIndex);var b=a.codTipologiaMinicard,c=a.descrizioneTipologia,d=a.importoRicaricaFormat.replace(/\&#8364;/g,"\u20ac");PlaySound("beep3");setTimeout(function(){jConfirm($.format(confermaRicaricaMsg,[c,d]),attenzioneMsg,function(e){if(e){block();e={inputText:document.getElementById("inputText").value,codTipologiaMinicard:b,barcode:selectedBarcode,operation:"RICARICA"};service.getRows(e).addCallback(rowsCallback)}else{$("#close").trigger("click");
setModalita("CONSEGNA")}})},200)};
function setModalita(a){switch(a){case "MODALITA_RICARICA":$("#content1").css({"background-color":"#ff6666"});$("#venditeDiv").css({"background-color":"#ff6666"});break;case "LETTURA_STATO":$("#content1").css({"background-color":"#ffcc66"});$("#venditeDiv").css({"background-color":"#ffcc66"});break;case "CONSEGNA":$("#content1").css({"background-color":"#cccccc"});$("#venditeDiv").css({"background-color":"#fff"});break;default:$("#content1").css({"background-color":"#cccccc"});$("#venditeDiv").css({"background-color":"#fff"})}modalita=
a;$("#butRicarica").css({"background-color":"#ffcc99"});$("#butStato").css({"background-color":"#ffffcc"});$("#inputText").focus()}$("#separatorR").is(":visible")?$("#separatorR").tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgNascondiBarraProdottiVari+"</b>"}}):$("#separatorR").tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgMostraBarraProdottiVari+"</b>"}});
$("#separatorL").is(":visible")?$("#separatorL").tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgNascondiBarraPubblicazioni+"</b>"}}):$("#separatorL").tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgMostraBarraPubblicazioni+"</b>"}});function showSidebar(){objMain.addClass("use-sidebar");var a="";$("#arrowUpDiv").show();a=$("#sidebarL").is(":visible")?width1:width2;$("#content").css({width:a});resizeGrid()}
function hideSidebar(){objMain.removeClass("use-sidebar");var a="";$("#arrowUpDiv").hide();a=$("#sidebarL").is(":visible")?width2:width3;$("#content").css({width:a});resizeGrid()}function showSidebarL(){objMain.addClass("use-sidebar-L");var a="";a=$("#sidebar").is(":visible")?width1:width2;$("#content").css({width:a});resizeGrid()}function hideSidebarL(){objMain.removeClass("use-sidebar-L");var a="";a=$("#sidebar").is(":visible")?width2:width3;$("#content").css({width:a});resizeGrid()}
function resizeGrid(){venditeTableObject.resize();venditeTableObject.update()}
function showCats(){var a="";$.each(arrCat,function(b,c){if(arrCat.length==1)return showSubCat(b);var d=c.substring(0,c.indexOf("|"));a+='<img id="'+b+'" style="display: inline-block;" class="pneImg" title="'+c.substring(c.indexOf("|")+1)+'" src="/immagini_miniature_edicola_prodotti_vari/'+d+'" border="1" width="'+prodIconWidth+'px" height="'+prodIconHeight+'px" onclick="javascript: showSubCat('+b+')"/>'});$("#pneDiv").html(a);$("#arrowUpDiv").hide();$(".pneImg").tooltip({delay:0,showURL:false})}
function showSubCat(a){var b="",c=0,d="";$.each(arrScat,function(e,f){if(e.indexOf(a+"_")!=-1){d=e;var h=f.substring(0,f.indexOf("|"));b+='<img id="'+e+'" style="display: inline-block;" class="pneImg" title="'+f.substring(f.indexOf("|")+1)+'" src="/immagini_miniature_edicola_prodotti_vari/'+h+'" border="1" width="'+prodIconWidth+'px" height="'+prodIconHeight+'px" onclick="javascript: showProd(\''+e+"',false)\"/>";c++}});if(c==1)return showProd(d,true);attachArrowsCat();$("#pneDiv").html(b);$("#pneDiv img").tooltip({delay:0,
showURL:false})}
function showProd(a,b){var c="";$.each(arrProd,function(d,e){if(d.startsWith(a)){e=e.replace(/([\'])/g,"\\$1");var f=e.split("|"),h=typeof f[3]==="undefined"||f[3]==""?displayNum(Number("0").toFixed(2)):displayNum(Number(f[3]).toFixed(2));f=f[1]+"&nbsp;(&euro;&nbsp;"+h+")";h=e.substring(0,e.indexOf("|"));c+='<img id="'+d+'" style="display: inline-block;" class="pneImg" title="'+f+'" src="/immagini_miniature_edicola_prodotti_vari/'+h+'" border="1" width="'+prodIconWidth+'px" height="'+prodIconHeight+
'px" onclick="javascript: sellProd(\''+d+"','"+e+"')\"/>"}});b?attachArrowsCat():attachArrowsSCat(a);$("#pneDiv").html(c);$("#pneDiv img").tooltip({delay:0,showURL:false})}function attachArrowsCat(){$("#arrUp").attr("title",msgMostraCategorie);$("#arrUp").click(function(){showCats()});$("#arrUp").tooltip({delay:0,showURL:false});$("#arrowUpDiv").show()}
function attachArrowsSCat(a){$("#arrUp").attr("title",msgMostraSottocategorie);$("#arrUp").click(function(){showSubCat(a.substring(0,a.indexOf("_")))});$("#arrUp").tooltip({delay:0,showURL:false});$("#arrowUpDiv").show()}
function sellProd(a,b){var c=$("#qta").val();if(isNaN(c)){jAlert(moltiplicatoreInvalidoMsg,attenzioneMsg.toUpperCase(),function(){$.alerts.dialogClass=null;$("#qta").focus()});return false}var d=a.substring(a.lastIndexOf("_")+1),e=b.split("|"),f=e[1].replace(/\&#8364;/g,"\u20ac"),h=e[2],g=e[3],k=e[4].replace(/\&#8364;/g,"\u20ac"),i=e[5],m=getLastGiacenza(d);if(Number(c)>maxValueMultiplier){PlaySound("beep3");jConfirm(moltiplicatoreMoltoGrandeMsg.replace("{0}",c),attenzioneMsg,function(n){if(n)m<=
0?jConfirm(msgProdottoSenzaGiacenza.replace("{0}",f),attenzioneMsg,function(l){if(l)sellProduct(g,c,d,f,h,k,i);else return false}):sellProduct(g,c,d,f,h,k,i);else{$("#qta").val("1");$("#inputText").focus()}})}else m<=0?jConfirm(msgProdottoSenzaGiacenza.replace("{0}",f),attenzioneMsg,function(n){if(n)sellProduct(g,c,d,f,h,k,i);else return false}):sellProduct(g,c,d,f,h,k,i)}
function sellProduct(a,b,c,d,e,f,h){if(a==""){jPrompt(msgInserisciPrezzo,null,msgVenditaProdottiVariReparto,function(g){if(g!=null&&g.length>0){g=parseLocalNum(g);isNaN(g)||addToTableVendite(b,c,d,g,"",f,h)}});mapGiacenze["prod_"+c]=getLastGiacenza(c)-b;$("#qta").val(1);setTimeout(function(){addRightClickMenu()},100);return false}mapGiacenze["prod_"+c]=getLastGiacenza(c)-b;addToTableVendite(b,c,d,a,e,f,h);setTimeout(function(){addRightClickMenu()},100);$("#qta").val(1)}
function getLastGiacenza(a){return isNaN(mapGiacenze["prod_"+a])?0:mapGiacenze["prod_"+a]}
function addToTableVendite(a,b,c,d,e,f,h){var g=displayNum(Number(d).toFixed(2)),k=displayNum((Number(d)*Number(a)).toFixed(2));a={prodottoNonEditoriale:"true",progressivo:getProgressivo(venditeTableObject),coddl:0,idtn:0,numeroCopertina:"",quantita:a,idProdotto:b,titolo:c,sottoTitolo:f,prezzoCopertina:d,prezzoCopertinaFormat:g,barcode:e,importoFormat:k,giacenzaIniziale:mapGiacenze["prod_"+b],aliquota:h};addTableData(venditeTableObject,venditeTabIdField,a)};