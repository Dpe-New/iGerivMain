var context,categoryOrderChanged=false,subCategoryOrderChanged=false,productOrderChanged=false;
window.onbeforeunload=function(){if(categoryOrderChanged){var c=[];$("#mieiProdottiTree span.level1").each(function(){c.push($(this).attr("codcategoria"))});dojo.xhrGet({url:appContext+"/pne_updateCategoryPositions.action?sortedCategoryIds="+c,handleAs:"text",headers:{"Content-Type":"application/json; charset=uft-8"},preventCache:true,sync:true})}if(subCategoryOrderChanged){var f=[];$("#mieiProdottiTree span.subFolder").each(function(){$(this).attr("changed")=="true"&&f.push($(this).attr("codcategoria")+
"_"+$(this).attr("codsubcategoria"))});dojo.xhrGet({url:appContext+"/pne_updateSubCategoryPositions.action?sortedSubcategoryIds="+f,handleAs:"text",headers:{"Content-Type":"application/json; charset=uft-8"},preventCache:true,sync:true})}if(productOrderChanged){var h=[];$("#mieiProdottiTree span.fileEdicola").each(function(){$(this).attr("changed")=="true"&&h.push($(this).attr("id").replace("folder_2_",""))});dojo.xhrGet({url:appContext+"/pne_updateProductPositions.action?sortedProdottiIds="+h,handleAs:"text",
headers:{"Content-Type":"application/json; charset=uft-8"},preventCache:true,sync:true})}};
$(document).ready(function(){conditionHasActionMessages&&jConfirm(prodErrMsg,attenzioneMsg,function(c){if(c){c=$("#codProdotto").val().trim();window.parent.document.getElementById("prodottiEdicolaFrame").contentDocument.location=appContext+"/pne_deleteProdottoEdicola.action?codProdotto="+c+"&deleteDependenciesProdotto=true"}});conditionHasActionErrors&&jAlert(actionErrors,attenzioneMsg,function(){$.alerts.dialogClass=null});$("#prodottiTree").treeview({speed:"slow",collapsed:true});docReady()});
function docReady(){prepareProdottiEdicola();prepareProdottiGenerici();$("#memorizza").click(function(){ray.ajax()});if(lastProdotto.trim()!=""&&lastProdotto!=null){showProduct(lastProdotto);prevProdotto.trim()!=""&&prevProdotto!=null&&showProduct(prevProdotto)}else if(lastSubcategory.trim()!=""&&lastSubcategory!=null){var c=$("#"+lastSubcategory).parents("li.expandable");c.children("ul").css({display:"block"});c.removeClass("expandable").removeClass("lastExpandable").addClass("collapsable").addClass("lastCollapsable");
c.children("div").first().removeClass("expandable-hitarea").addClass("collapsable-hitarea").removeClass("lastExpandable-hitarea").addClass("lastCollapsable-hitarea");c.find("ul li.expandable").find("ul").css({display:"none"});$("#mieiProdottiTree").removeAttr("style")}}
function showProduct(c){c=$("#"+c);var f=c.parents("li.expandable");f.removeClass("expandable").removeClass("lastExpandable").addClass("collapsable").addClass("lastCollapsable");f.children("div").first().removeClass("expandable-hitarea").addClass("collapsable-hitarea").removeClass("lastExpandable-hitarea").addClass("lastCollapsable-hitarea");c.closest("li.collapsable").find("ul").css({display:"block"});c.parents("ul").css({display:"block"});c.parents("li.collapsable").last().children("ul").css({display:"block"});
$("#mieiProdottiTree").removeAttr("style")}
function prepareProdottiGenerici(){var c=$("span[id*='folderTemplate_2_']"),f=$("#prodottiEdicola"),h=$("#prodottiEdicola li"),d=$("#prodottiEdicola span.subFolder");c.draggable({cancel:"a.ui-icon",revert:"invalid",helper:"clone",cursor:"move",zIndex:"5000"});f.droppable({accept:"span.file",activeClass:"ui-state-highlight",drop:function(a,b){var e=Number($(b.draggable).attr("id").replace("folderTemplate_2_","").trim());window.parent.document.getElementById("prodottiEdicolaFrame").contentDocument.location.href=appContext+
"/pne_showProdotti.action?idProdottiEdicola="+e}});d.droppable({accept:function(a){var b=a.attr("tagName")=="LI";a=a.find("span:first").hasClass("fileEdicola");return b&&a?true:false},activeClass:"ui-state-highlight",hoverClass:"ui-state-active",drop:function(a,b){categoryOrderChanged=true;var e=Number($(b.draggable).find("span:first").attr("id").replace("folder_2_","").trim()),g=$(this).attr("codcategoria").trim(),i=$(this).attr("codsubcategoria").trim();window.parent.document.getElementById("prodottiEdicolaFrame").contentDocument.location.href=
appContext+"/pne_updateProductCategory.action?codProdotto="+e+"&codCategoria="+g+"&codSottoCategoria="+i}});$("#gallery").droppable({accept:"span.fileEdicola",activeClass:"ui-state-highlight",drop:function(a,b){$(b.draggable).remove();var e=Number($(b.draggable).attr("id").replace("folder_2_","").trim());window.parent.document.getElementById("prodottiEdicolaFrame").contentDocument.location.href=appContext+"/pne_deleteProdottoEdicola.action?codProdotto="+e}});f.sortable({delay:300,cursor:"pointer",
placeholder:"ui-state-highlight",items:"> ul > li",axis:"y",revert:true,update:function(){categoryOrderChanged=true}});h.sortable({delay:300,cursor:"pointer",placeholder:"ui-state-highlight",items:"> ul > li",axis:"y",update:function(a,b){if($(b.item.context).find("span:first").attr("id").indexOf("sucategory")!=-1)subCategoryOrderChanged=true;else productOrderChanged=true;$(this).closest("li").find("span").each(function(){$(this).attr("changed",true)})}});$("#myProducts").tooltip({delay:0,showURL:false,
bodyHandler:function(){return"<b>"+msgMieiProdotti+"</b>"}});$("#availableProducts, #selectedProdcuts").tooltip({delay:0,showURL:false,bodyHandler:function(){return"<b>"+msgProdottiDisponibili+"</b>"}})}
function prepareProdottiEdicola(){function c(d,a){var b=a.attr("id").replace("folder_2_","");if(d=="delete")jConfirm(msgCancellareProdotto,attenzioneMsg,function(e){if(e){ray.ajax();window.parent.document.getElementById("prodottiEdicolaFrame").contentDocument.location.href=appContext+"/pne_deleteProdottoEdicola.action?codProdotto="+b}});else d=="edit"&&openDiv("popup_name",800,500,appContext+"/pne_editProdottoEdicola.action?codProdotto="+b,"","",window.parent.document)}function f(d,a){var b=a.attr("codcategoria").trim(),
e=a.attr("codsubcategoria").trim(),g="";if(d=="insertScat")g=appContext+"/pne_editSottoCategoria.action?codCategoria="+b;else if(d=="editScat")g=appContext+"/pne_editSottoCategoria.action?codCategoria="+b+"&codSottoCategoria="+e;else d=="deleteScat"&&jConfirm(msgCancellareSottocategoria.replace("{0}",a.text()),attenzioneMsg,function(i){if(i){ray.ajax();window.parent.document.getElementById("prodottiEdicolaFrame").contentDocument.location.href=appContext+"/pne_deleteSottoCategoria.action?codCategoria="+
b+"&codSottoCategoria="+e}});g!=""&&openDiv("popup_name",600,350,g,"","",window.parent.document)}function h(d,a){var b=a.attr("codcategoria").trim(),e="";if(d=="insertCat")e=appContext+"/pne_editCategoria.action";else if(d=="insertScat")e=appContext+"/pne_editSottoCategoria.action?codCategoria="+b;else if(d=="editCat")e=appContext+"/pne_editCategoria.action?codCategoria="+b;else d=="deleteCat"&&jConfirm(msgCancellareCategoria.replace("{0}",a.text()),attenzioneMsg,function(g){if(g){ray.ajax();window.parent.document.getElementById("prodottiEdicolaFrame").contentDocument.location.href=
appContext+"/pne_deleteCategoria.action?codCategoria="+b}});e!=""&&openDiv("popup_name",600,350,e,"","",window.parent.document)}$("#mieiProdottiTree").treeview({speed:"slow",collapsed:true});$("span[id*='folderTemplate_']").click(function(){$(this).effect("highlight",{},1E3)});isProdottiEdicolaEmpty&&$("#prodottiEdicola").contextMenu({menu:"categoryInsert",yTop:-10,xLeft:0,highlight:true},function(){openDiv("popup_name",600,350,appContext+"/pne_editCategoria.action","","",window.parent.document)});
$("span.level1").contextMenu({menu:"categoryEditDelete",yTop:-10,xLeft:0,highlight:true},function(d,a,b){h(d,a,b)});$("span.fileEdicola").contextMenu({menu:"myMenu",yTop:-10,xLeft:0,highlight:true},function(d,a,b){c(d,a,b)});$("#prodottiEdicola span.subFolder").contextMenu({menu:"subcategoryEditDelete",yTop:-10,xLeft:0,highlight:true},function(d,a,b){if(d=="insertProd"){d=a.parent().parent().parent().find("span").first().text().trim();a=a.text().trim();a=appContext+"/pne_editProdottoEdicola.action?catTitle="+
escape(d)+"&subCatTitle="+escape(a);openDiv("popup_name",800,540,a,"","",window.parent.document)}else f(d,a,b)})};