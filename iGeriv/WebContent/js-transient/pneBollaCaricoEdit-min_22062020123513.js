var stopWaitingDivBollaCarico=false,allowSearch=false;
$(document).ready(function(){codCausale!=null&&codCausale>0&&$("#causaliEdit").val(Number(codCausale));$.datepicker.setDefaults($.datepicker.regional.it);$("#dataDocumentoEdit").datepicker();$("#deleteRow, #addRow, #addFornitore").tooltip({delay:0,showURL:false});$("#meBollaCarico").click(function(){stopWaitingDivBollaCarico||ray.ajax()});addFadeLayerEvents();setLastFocusedElement();setTableFields();var a=$("#fornitoriEdit").val(),b=a;$("#fornitoriEdit").focus(function(){b=$(this).val()}).change(function(){$(this).unbind("focus");
if($(this).val()==codDl){$(this).bind("focus");$(this).val(b);return false}if($("#BollaCaricoEditTab_table > tbody tr").length>1){PlaySound("beep3");jConfirm(msgConfirmAzzerareVociBolla,attenzioneMsg,function(c){if(c){$("#BollaCaricoEditTab_table tbody tr:not(:last)").remove();a=$("#fornitoriEdit").val()}else $("#fornitoriEdit").val(a);return false})}});if(disabled){$("#BollaCaricoEditForm input:not(input[type=hidden])").each(function(){$(this).attr("disabled",true)});$("#BollaCaricoEditForm select").each(function(){$(this).attr("disabled",
true)});$("#addRow, #deleteRow, #addFornitore").removeAttr("onclick")}else{isNew&&codFornitore!=null&&$("#fornitoriEdit").val(codFornitore);$("#fornitoriEdit").focus()}});
function setTableFields(){var a=0;$("#BollaCaricoEditTab_table tbody tr").each(function(){var b=$(this);if(!b.hasClass("calcRow")){var c='<input name="dettagli['+a+'].pk.idDocumento" id="idDoc'+a+'" value="" type="hidden">';c+='<input name="dettagli['+a+'].prodotto.edicola.codEdicola" value="'+userId+'" type="hidden">';c+='<input name="dettagli['+a+'].magazzinoDa" value="'+magazzinoEsterno+'" type="hidden">';c+='<input name="dettagli['+a+'].magazzinoA" value="'+magazzinoInterno+'" type="hidden">';
c+='<input name="dettagli['+a+'].prodotto.descrizioneProdottoA" id="descrizioneProdottoA'+a+'" value="" type="hidden">';b.append(c);var j=b.find("td"),h=b.find("td:nth-child(1)");c=b.find("td:nth-child(7)");j=j.first().find("input[id*='prog']").val();h=h.find("input[name*='codiceProdottoFornitore']");c=c.find("select[id*='aliquota']");h.attr("oldVal",h.val());c.attr("oldVal",c.val());c.attr("disabled",true);attachEventsToRow($(this),j);b.attr("prodottoDl")=="true"&&h.attr("disabled",true);a++}})}
function removeTableRow(){if(disabled)return false;if($("#"+lastFocusedFieldId.replace(/([|@.\[\]])/g,"\\$1")).length>0){var a=$("#"+lastFocusedFieldId.replace(/([|@.\[\]])/g,"\\$1")).closest("tr");if(a.hasClass("odd")||a.hasClass("even"))a.remove()}else $("#BollaCaricoEditTab_table > tbody tr:last").prev().remove();updateTotal()}function getIvaOptions(){for(var a="",b=numbersStr.split(","),c=0;c<b.length;c++)a+='<option value="'+b[c]+'">'+b[c]+"</option>";return a}
function addTableRow(){if(disabled)return false;$("#BollaCaricoEditTab_table > tbody tr td:nth-child(2)").find("img").each(function(){$(this).remove()});var a=$("#BollaCaricoEditTab_table > tbody tr").length,b='<tr class="odd" style="height:22px"><td style="font-size: 100%; text-align: left;" width="8%"><input name="dettagli['+a+'].codiceProdottoFornitore" id="codiceProdottoFornitore'+a+'" value="" class="extremeTableFieldsSmaller" style="font-size: 100%; text-align: left;" size="6" maxlength="10" type="text"></td>';
b+='<td style="text-align: left;" width="25%; white-space: nowrap;"><input name="dettagli['+a+'].prodotto.barcode" id="barcode'+a+'" value="" class="extremeTableFieldsSmaller" style="font-size: 100%; text-align: left; vertical-align:middle" size="20" maxlength="20" type="text">&nbsp;<img src="/app_img/product.gif" width="18px" height="18px" id="product" alt='+msgAggiungiProdotto+' border="0" title="'+msgAggiungiProdotto+'" style="cursor:pointer; vertical-align:middle" onclick="javascript: addProduct();"/></td>';
b+='<td width="35%" style="display:block; white-space:nowrap;"></td>';b+='<td width="8%" style="font-size: 100%; text-align: left;"><input name="dettagli['+a+'].quantita" id="quant'+a+'" value="" class="extremeTableFieldsSmaller" style="font-size: 100%; text-align: left;" size="3" maxlength="10" type="text"></td>';b+='<td style="font-size: 100%; text-align: left;" width="8%"><input name="dettagli['+a+'].prezzo" id="prezzo'+a+'" value="" class="extremeTableFieldsSmaller" style="font-size: 100%; text-align: right;" size="8" maxlength="10" type="text"></td>';
b+='<td style="font-size: 100%; text-align: left;" width="8%"><input name="dettagli['+a+'].importo" id="importo'+a+'" value="" class="extremeTableFieldsSmaller" style="font-size: 100%; text-align: right;" size="8" maxlength="10" type="text"></td>';b+='<td style="font-size: 100%; text-align: left;" width="5%"><select name="dettagli['+a+'].prodotto.aliquota" id="aliquota'+a+'" value="" class="extremeTableFieldsLarger" style="font-size: 12px; width: 60px;">'+getIvaOptions()+"</select></td>";b+='<input name="dettagli['+
a+'].pk.progressivo" id="prog'+a+'" value="" type="hidden">';b+='<input name="dettagli['+a+'].pk.idDocumento" id="idDoc'+a+'" value="" type="hidden">';b+='<input name="dettagli['+a+'].prodotto.codProdottoInterno" id="prodInterno'+a+'" value="" type="hidden">';b+='<input name="dettagli['+a+'].prodotto.edicola.codEdicola" value="'+userId+'" type="hidden">';b+='<input name="dettagli['+a+'].magazzinoDa" value="'+magazzinoEsterno+'" type="hidden">';b+='<input name="dettagli['+a+'].magazzinoA" value="'+
magazzinoInterno+'" type="hidden">';b+='<input name="dettagli['+a+'].prodotto.descrizioneProdottoA" id="descrizioneProdottoA'+a+'" value="" type="hidden">';b+="</tr>";if($("#"+lastFocusedFieldId).length>0&&$("#"+lastFocusedFieldId).attr("name").indexOf("dettagli")!=-1){var c=$("#"+lastFocusedFieldId).closest("tr");if(c.hasClass("odd")||c.hasClass("even"))c.after(b)}else $("#BollaCaricoEditTab_table tbody tr:last").before(b);$("#product").tooltip({delay:0,showURL:false});$("#codProdottoInterno0").attr("disabled",
true);setLastFocusedElement();$("#codiceProdottoFornitore"+a).focus();attachEventsToRow($("#codiceProdottoFornitore"+a).closest("tr"),a);setFocusedFieldStyle()}
function attachEventsToRow(a,b){var c=a.find(":input").first(),j=a.find("td:nth-child(2)").find(":input").first(),h=a.find("td:nth-child(4)").find(":input").first(),m=a.find("td:nth-child(5)").find(":input").first(),k=a.find("td:nth-child(6)").find(":input").first(),r=a.find("td:nth-child(7)").find(":input").first(),q=$("#descrizioneProdottoA"+b);m.numeric({decimal:",",negative:false});c.autocomplete({minLength:2,search:function(){if(allowSearch){ray.ajax();return true}else return false},source:function(d,
g){dojo.xhrGet({url:appContext+"/automcomplete_getProdottoNonEditorialeInBolla.action",delay:100,preventCache:true,handleAs:"json",headers:{"Content-Type":"application/json; charset=uft-8"},content:{term:d.term},handle:function(f){unBlockUI();if(f.length==0)focusNextField();else if(f.length==1){var e=c.closest("td"),i=e.next(),l=e.closest("tr").find(":input:hidden[name*='prodotto.codProdottoInterno']");i=i.find(":input");e=e.next().next();var o=e.next().next(),s=o.find(":input");o=o.next().next().find("select");
i.val(f[0].barcode);l.val(f[0].codProdotto);s.val(displayNum(Number(f[0].prezzo).toFixed(2)));i.attr("disabled",true);e.html(f[0].descrizione);o.val(f[0].iva);o.attr("oldVal",f[0].iva);f[0].iva!=""?o.attr("disabled",true):o.attr("disabled",false);c.attr("oldVal",c.val());f[0].prodottoDl=="true"?c.attr("disabled",true):c.attr("disabled",false);setTimeout(function(){$("#"+lastFocusedFieldId).closest("td").next().next().next().find(":input").focus()},100)}else g($.map(f,function(p){return{id:p.codProdotto,
label:p.codiceFornitore+" - "+p.descrizione,descrizione:p.descrizione,value:p.codiceFornitore,prezzo:p.prezzo,barcode:p.barcode,iva:p.iva,prodottoDl:p.prodottoDl}}))}})},select:function(d,g){var f=c.closest("td"),e=f.next(),i=f.closest("tr").find(":input:hidden[name*='prodotto.codProdottoInterno']");e=e.find(":input");f=f.next().next();var l=f.next().next(),o=l.find(":input");l=l.next().next().find("select");e.val(g.item.barcode);i.val(g.item.id);o.val(displayNum(Number(g.item.prezzo).toFixed(2)));
e.attr("disabled",true);f.html(g.item.descrizione);l.val(g.item.iva);l.attr("oldVal",g.item.iva);g.item.iva!=""?l.attr("disabled",true):l.attr("disabled",false);c.attr("oldVal",c.val());g.item.prodottoDl=="true"?c.attr("disabled",true):c.attr("disabled",false);setTimeout(function(){$("#"+lastFocusedFieldId).closest("td").next().next().next().find(":input").focus()},100)}});c.keypress(function(d){if((d.keyCode?d.keyCode:d.charCode)==13){d.preventDefault();allowSearch=true}});c.focus(function(){$(this).val()==
""&&j.attr("disabled",false)});c.keyup(function(){$(this).val()==""&&j.attr("disabled",false)});h.keypress(function(d){if((d.keyCode?d.keyCode:d.charCode)==13){d.preventDefault();focusNextField();calcImporto($(this),k,m)}});m.keypress(function(d){if((d.keyCode?d.keyCode:d.charCode)==13){d.preventDefault();focusNextField();try{calcImporto(h,k,$(this));$(this).val(displayNum($(this).val()))}catch(g){setTimeout('$("#'+prodFieldId+'")[0].focus();',100)}}});m.blur(function(){var d=$(this).attr("id");try{calcImporto(h,
k,$(this));$(this).val(displayNum($(this).val()))}catch(g){setTimeout('$("#'+d+'")[0].focus();',100)}});k.keypress(function(d){if((d.keyCode?d.keyCode:d.charCode)==13){d.preventDefault();focusNextField()}});r.keypress(function(d){if((d.keyCode?d.keyCode:d.charCode)==13){d.preventDefault();addTableRow()}});j.keypress(function(d){d=d.keyCode?d.keyCode:d.charCode;if(!isNaN($(this).val().trim())&&d==13)allowSearch=true});j.autocomplete({minLength:3,search:function(){if(isNaN($(this).val().trim())||allowSearch){allowSearch=
false;ray.ajax();return true}else return false},source:function(d,g){var f=j.val();dojo.xhrGet({url:appContext+"/pubblicazioniRpc_getPneBarcodeOrDescrizione.action?barcode="+f+"&findProdottiSenzaFornitore=true",delay:100,preventCache:true,handleAs:"json",headers:{"Content-Type":"application/json; charset=uft-8"},content:{term:d.term},handle:function(e){unBlockUI();if((e==""||e.length==0||e[0].length==0)&&isNaN(f)){PlaySound("beep3");jConfirm(msgConfirmAggiungereNuovoProdotto.replace("{0}",f),attenzioneMsg,
function(n){if(n){addProduct(f);return true}return false})}else if(e.length==1){var i=c.closest("td"),l=i.next(),o=i.closest("tr").find(":input:hidden[name*='prodotto.codProdottoInterno']");l=l.find(":input");var s=i.next().next();i=i.find(":input");var p=s.next().next().find(":input"),t=s.next().next().next().next().find("select");l.val(e[0].barcode);o.val(e[0].codProdotto);s.html(e[0].descrizione);p.val(displayNum(Number(e[0].ultimoPrezzoAcquisto).toFixed(2)));t.val(e[0].iva);t.attr("oldVal",e[0].iva);
e[0].iva!=""?t.attr("disabled",true):t.attr("disabled",false);q.val(e[0].descrizione);if(e[0].codiceProdottoFornitore.length>0){i.val(e[0].codiceProdottoFornitore);i.attr("oldVal",e[0].codiceProdottoFornitore);e[0].prodottoDl=="true"?i.attr("disabled",true):i.attr("disabled",false)}$("#"+lastFocusedFieldId).closest("td").next().next().find(":input").focus()}else g($.map(e,function(n){return{id:n.codProdotto,label:n.barcode+" - "+n.descrizione,descrizione:n.descrizione,value:n.barcode,barcode:n.barcode,
iva:n.iva,codiceProdottoFornitore:n.codiceProdottoFornitore,ultimoPrezzoAcquisto:n.ultimoPrezzoAcquisto,prodottoDl:n.prodottoDl}}))}})},select:function(d,g){var f=c.closest("td"),e=f.next().next(),i=f.closest("tr").find(":input:hidden[name*='prodotto.codProdottoInterno']");f=f.find(":input");var l=e.next().next().next().next().find("select");i.val(g.item.id);e.html(g.item.descrizione);e.next().next().find(":input").val(displayNum(Number(g.item.ultimoPrezzoAcquisto).toFixed(2)));l.val(g.item.iva);
l.attr("oldVal",g.item.iva);g.item.iva!=""?l.attr("disabled",true):l.attr("disabled",false);q.val(g.item.descrizione);if(g.item.codiceProdottoFornitore.length>0){f.val(g.item.codiceProdottoFornitore);f.attr("oldVal",g.item.codiceProdottoFornitore);g.item.prodottoDl=="true"?f.attr("disabled",true):f.attr("disabled",false)}setTimeout(function(){$("#"+lastFocusedFieldId).closest("td").next().next().find(":input").focus()},100)}});h.blur(function(){var d=$(this).attr("id");try{calcImporto($(this),k,m)}catch(g){setTimeout('$("#'+
d+'")[0].focus();',100)}})}function calcImporto(a,b,c){var j=0;try{j=Number(parseLocalNum($(a).val())).toFixed(2)}catch(h){throw h;}a=0;try{a=Number(parseLocalNum($(c).val())).toFixed(2)}catch(m){throw m;}if(!isNaN(j)&&!isNaN(a)){c=Number(j*a);$(b).val(displayNum(c.toFixed(2)));updateTotal()}}
function updateTotal(){var a=$("#BollaCaricoEditTab_table tbody tr.calcRow td.calcResult"),b=0;$("#BollaCaricoEditTab_table tbody tr td:nth-child(6)").each(function(){var c=$(this).find(":input:text");if(c.length>0){c=Number(parseLocalNum(c.val()));b+=c}});a.text(displayNum(b.toFixed(2)))}function focusNextField(){$("#"+lastFocusedFieldId).closest("td").next().find(":input").focus().select()}function afterSuccessSave(){$("#ricerca").trigger("click")}
function doDelete(){PlaySound("beep3");jConfirm(msgCancellareBolla,attenzioneMsg,function(a){if(a){setFormAction("BollaCaricoEditForm","pneBollaCarico_deleteBolla.action","","messageDiv",true);deleted=true;setTimeout("unBlockUI();",100)}else{setTimeout("unBlockUI();",100);return false}})}
function validateFieldsBollaCarico(a){if($("#fornitoriEdit").val()==""){if(a){$.alerts.dialogClass="style_1";jAlert(msgCampoObbligatorio.replace("{0}",msgFornitore),msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();return false}if($("#dataDocumentoEdit").val()==""){if(a){$.alerts.dialogClass="style_1";jAlert(msgCampoObbligatorio.replace("{0}",msgDataDocumento),msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();return false}else if(!checkDate($("#dataDocumentoEdit").val())){if(a){$.alerts.dialogClass=
"style_1";jAlert(msgFormatoDataInvalido.replace("{0}",$("#dataDocumentoEdit").val()),msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();return false}if($("#numeroDocumentoEdit").val()==""){if(a){$.alerts.dialogClass="style_1";jAlert(msgCampoObbligatorio.replace("{0}",msgNumeroDocumento),msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();return false}if($("#causaliEdit").val()==""){if(a){$.alerts.dialogClass="style_1";jAlert(msgCampoObbligatorio.replace("{0}",msgCausale),
msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();return false}var b=0;try{var c=[];$("#BollaCaricoEditTab_table tbody tr").each(function(){var h=$(this).find("td:nth-child(3)").text().trim();$(this).find("input[name*='dettagli'], select[name*='dettagli']").each(function(){var m=$(this).attr("name"),k=$(this).attr("id");m.indexOf("codProdottoInterno")!=-1&&c.push($(this).val());if(k.indexOf("quant")!=-1&&$(this).val()==""){if(a){$.alerts.dialogClass="style_1";jAlert(msgCampoObbligatorio.replace("{0}",
msgQuantita),msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();throw k;}else if(k.indexOf("quant")!=-1&&Number($(this).val())>1E3){if(a){$.alerts.dialogClass="style_1";jAlert(numeroNonValido,msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();throw k;}if(k.indexOf("prezzo")!=-1&&$(this).val()==""){if(a){$.alerts.dialogClass="style_1";jAlert(msgCampoObbligatorio.replace("{0}",msgPrezzo),msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();throw k;}else if(k.indexOf("prezzo")!=
-1&&Number($(this).val())>1E3){if(a){$.alerts.dialogClass="style_1";jAlert(numeroNonValido,msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();throw k;}k.indexOf("aliquota")!=-1&&$(this).val().trim()!=""&&$(this).attr("disabled",false);if(m.indexOf("codiceProdottoFornitore")!=-1&&$(this).val().trim()!=""){var r=$(this).val().trim(),q=$(this).attr("oldVal");if(typeof q!="undefined"&&r!=""&&q!="")if(!byPassCodiceProdottoFornitoreCheck&&q!=r){var d=$(this).attr("id");setTimeout(function(){PlaySound("beep3");
jConfirm(msgCodiceProdottoFornitoreCambiato.replace("{0}",q).replace("{1}",r).replace("{2}",h),attenzioneMsg.toUpperCase(),function(e){var i=$("#"+d);if(e){byPassCodiceProdottoFornitoreCheck=true;setTimeout(function(){return validateFieldsBollaCarico(true)&&setFormAction("BollaCaricoEditForm","pneBollaCarico_saveBolla.action","","messageDiv")},100)}else{byPassCodiceProdottoFornitoreCheck=false;i.val(q);i.attr("oldVal",q);unBlockUI();$("#"+k).focus();enableAllFormFields()}})},100);throw k;}}var g=
m.indexOf("["),f=m.indexOf("]")+1;g=m.substring(g,f);$(this).attr("name",m.replace(g,"["+b+"]"));k.indexOf("prog")!=-1&&$(this).val(b);k.indexOf("idDoc")!=-1&&$(this).val($("#idDocumento").val());k.indexOf("descrizioneProdottoA")!=-1&&$(this).val(h)});b++});if(findDuplicates(c).length>0){if(a){$.alerts.dialogClass="style_1";jAlert(msgProdottiDuplicatiBolla,msgAttenzione,function(){$.alerts.dialogClass=null})}unBlockUI();return false}}catch(j){$("#"+j.toString()).focus();return false}enableAllFormFields();
byPassCodiceProdottoFornitoreCheck=byPassAliquotaCheck=false;return true}function addForn(){openDiv("popup_name_det",900,350,appContext+"/pneFornitori_editFornitore.action","","det","");return false}
function nuovoProdottoSuccessCallback(){var a=$("#product").prev("input:text"),b=a.closest("tr"),c=b.find(":input").first().closest("td").next().next(),j=b.find("input[id^='prodInterno']").first();b=b.find("input[id^='descrizioneProdottoA']").first();a.val($("#prodottoEdicola\\.barcode").val());j.val($("#prodottoEdicola\\.codProdottoInterno").val());b.val($("#prodottoEdicola\\.descrizioneProdottoA").val());c.html($("#prodottoEdicola\\.descrizioneProdottoA").val());$("#closedet").trigger("click");
setTimeout(function(){$("#"+a.attr("id")).closest("td").next().next().find(":input").focus()},100)}
function afterSuccessSaveFromBollaCarico(a){$("#closedet").trigger("click");dojo.xhrGet({url:appContext+"/pubblicazioniRpc_getFornitori.action",handleAs:"json",headers:{"Content-Type":"application/json; charset=uft-8"},preventCache:true,handle:function(b){b=JSON.parse(b);for(var c="",j="",h=0;h<b.length;h++){j=a==b[h].value?"selected":"";c+="<option "+j+' value="'+b[h].key+'">'+b[h].value+"</option>"}$("#fornitoriEdit").empty();$("#fornitoriEdit").html(c);$("#fornitoriEdit").trigger("change")}})}
function addProduct(a){var b="";if(typeof a!="undefined"&&a!="")b="?descrizioneProdotto="+escape(a);openDiv("popup_name_det",800,500,appContext+"/pne_editProdottoEdicolaContent.action"+b,"","det","");return false}function closeLayerConfirm(){jConfirm(msgConfirmCloseDialog,attenzioneMsg,function(){$("#close").trigger("click")},true,false)};