var chars=[],keyCodes=[],pressed=false,regExpBarcode=/^[0-9]{10,18}$/,baseFieldName="copieLette";function setBarcodeKeyDownEvent(){$("#barcode").length>0&&$("#barcode").keydown({callback:autoIncrementField},manageBarcodeKeyDownBollaConsegna)}
function calcDiff(a){var b=a.closest("td").prev().prev().prev().text();if(isNaN(b))if(b.indexOf("(")!=-1){var c=b.substring(b.indexOf("(")+1,b.indexOf(")")).trim();b=Number(b.substring(0,b.indexOf("(")).trim())+Number(c)}else b=0;c=Number(a.val());if(c>999)a.val(a.data("prevval"));else{var d=a.next("input[type='text']");d.val(c-Number(b));keyEnterPressed(d);a.css("background","#fff");$("#totalHeader_7").text(calculateMancanze());$("#totalHeader_8").text(calculateEccedenze())}}
function setFieldEvents(){$fields=$("#BollaControlloForm input:text[name^=fieldMap]");$("#BollaControlloForm input:text[name^="+baseFieldName+"]").each(function(){var a=$(this);a.data("prevval",a.val());a.keydown(onFieldKeyDown);a.blur(calcDiff($(this)));a.numeric(false,null,function(){var b=$(this),c=b.next("input:hidden[name^=spunta]").next("input:hidden[name^=modificato]");Math.abs(b.val())>999&&b.val(b.data("prevval"));c.val("true")})})}
function getCurrentTextField(a){a=a.id.replace(/([|])/g,"\\$1");return $("#"+a)}function autoIncrementField(a,b){if(a!=""&&$("#"+a)){var c=$("input:text[id='"+b+a+"']"),d=isNaN(c.val())?0:Number(c.val())+1;c.val(d);c.data("prevval",d);calcDiff(c)}}
function executeBarcodeFound(a,b){var c=a.data("prevval");c=typeof c!=="undefined"&&c!=null&&!isNaN(c)?c:1;a.val(c);c=$("#"+b);var d=c.val();if(c.length>0){selectRowByBarcodeInf(d,baseFieldName,false);autoIncrementField(d,baseFieldName)}else noBarcodeFoundAction(b)}
function onFieldKeyDown(a){var b=getCurrentTextField(a.target?a.target:a.srcElement?a.srcElement:null);if(bollaRivKeyPress(a,b))return true;a.keyCode>=48&&a.keyCode<=57&&chars.push(String.fromCharCode(a.keyCode));if(a.keyCode==13||a.keyCode==32)keyCodes.push(a.keyCode);pressed==false&&setTimeout(function(){var c=chars.join("");if(regExpBarcode.test(c))executeBarcodeFound(b,c);else if(keyCodes.length===1&&(keyCodes[0]===13||keyCodes[0]===32)){a.preventDefault();calcDiff(b);setFieldsChanged(a);$("#barcode").val("");
$("#barcode").focus()}else if(c.length<10){c>999?b.val(b.data("prevval")):b.data("prevval",b.val());calcDiff(b)}chars=[];keyCodes=[];pressed=false},500);pressed=true;if(a.keyCode==13||a.keyCode==32)return false;return true}
function keyEnterPressed(a){a.data("prevval",a.val());a.trigger("change");var b=a.attr("id").replace(/([|])/g,"\\$1").replace(baseFieldName,"").replace("differenze","");b=$("#dpeChkbx_"+b);b.attr("checked","true");typeof checkboxChanged==="function"?checkboxChanged(b):setChangedFieldAttribute(a);return false}
function setFieldsToSave(a){var b=true;$("#BollaControlloForm input:text[name*=Map]").each(function(){var c=$(this),d=c.val();if(!isNaN(d)&&Number(d)>999)b=false;else{c.attr("disabled",!a);var e=c.next("input:hidden[name^=spunta]");if(a){c.data("oldVal",d);e.data("oldVal",e.val())}else{var f=e.next("input:hidden[name^=modificato]");c.data("oldVal")!=d||e.data("oldVal")!=e.val()?f.val("true"):f.val("false")}}});return b}
function manageBarcodeKeyDownBollaConsegna(a){var b=a.keyCode?a.keyCode:a.charCode;if(b===116)return true;else $("#aggiornaBarcode").length>0&&$("#aggiornaBarcode").is(":checked")&&$("#barcode").val().trim().length>0&&!isNaN($("#barcode").val().trim())&&b=="13"?callBarcodeVenditeService():manageBarcodeKeyDownInf(a.data.callback,a)}
function manageBarcodeKeyDownInf(a,b){if((b.keyCode?b.keyCode:b.charCode)=="13"){var c=b.target?b.target:b.srcElement?b.srcElement:null;b.preventDefault();var d=c.value;c=c.name;var e=$("#"+d);if(e.length>0){if(c.length>0)c=c.substring(c.indexOf("_")+1);selectRowByBarcodeInf(e.val(),c);typeof a==="function"&&a(e.val(),c)}else noBarcodeFoundAction(d)}}
function selectRowByBarcodeInf(a,b){if(a!=""&&$("#"+a)){playBarcodeBeep();lastFocusedRow!=""&&lastFocusedRow.css({backgroundColor:lastFocusColor});var c=$("input:text[id='"+b+a+"']");doActionsAfterSelectRowInf(c)}}
function doActionsAfterSelectRowInf(a){var b=a.parent().parent(),c=b.css("backgroundColor");$("#barcode").val("");b.css({backgroundColor:"#ffff66"});setTimeout(function(){a.select()},50);var d="";d=$.browser.safari?$("body"):$("html");var e=b.offset().top-40;d.scrollTop(e);lastFocusedRow=b;lastFocusColor=c}
function setFieldsChanged(a){var b=a.target?a.target:a.srcElement?a.srcElement:null;if((a.keyCode==13||a.keyCode==32)&&b.type=="text"){a.preventDefault();b=b.id.replace(/([|])/g,"\\$1");a=b.replace("differenze","").replace("reso","").replace("resoRichiamo","").replace("resoFuoriVoce","");b=$("#"+b);a=$("#dpeChkbx_"+a);a.attr("checked","true");typeof checkboxChanged==="function"?checkboxChanged(a):setChangedFieldAttribute(b);return false}}
function bollaRivKeyPress(a,b){var c=a.keyCode?a.keyCode:a.charCode;if(!a.shiftKey&&c==9||c==40){setTimeout(function(){var d=b.closest("tr").next().find("input:text[name^='"+baseFieldName+"']").first();b.css("background","#fff");b.trigger("blur");d.select()},200);return true}else if(a.shiftKey&&c==9||c==38){setTimeout(function(){var d=b.closest("tr").prev().find("input:text[name^='"+baseFieldName+"']").first();b.css("background","#fff");b.trigger("blur");d.select()},200);return true}return false}
function setBollaRivKeyPress(){$(this).bind("click",function(){!$("#popup_container").is(":visible")&&!$("#popup_name").is(":visible")&&$("#load").css("visibility")==="hidden"&&$('input[type="text"]:focus, input[type="checkbox"]:focus, textarea:focus, select:focus').length===0&&setTimeout(function(){$("#barcode").focus()},50)})};