<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/integration"
	xmlns:si-security="http://www.springframework.org/schema/integration/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:jee="http://www.springframework.org/schema/jee"
	xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:jms="http://www.springframework.org/schema/integration/jms"
	xmlns:file="http://www.springframework.org/schema/integration/file"
	xmlns:http="http://www.springframework.org/schema/integration/http"
	xmlns:mail="http://www.springframework.org/schema/integration/mail"
	xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans.xsd
			http://www.springframework.org/schema/context
			http://www.springframework.org/schema/context/spring-context.xsd
			http://www.springframework.org/schema/jee 
			http://www.springframework.org/schema/jee/spring-jee.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration.xsd
			http://www.springframework.org/schema/integration/security
      		http://www.springframework.org/schema/integration/security/spring-integration-security.xsd
      		http://www.springframework.org/schema/integration/file
            http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
			http://www.springframework.org/schema/integration/jms
			http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
			http://www.springframework.org/schema/integration/mail
            http://www.springframework.org/schema/integration/mail/spring-integration-mail.xsd
            http://www.springframework.org/schema/util 
            http://www.springframework.org/schema/util/spring-util.xsd">

	<!-- Configurazione JNDI delle risorse JMS nel Tomcat (in {CATALINA_HOME}/conf/server.xml 
		e {CATALINA_HOME}/conf/context.xml): -->
	<jee:jndi-lookup id="jmsFactory"
		jndi-name="java:comp/env/jms/ConnectionFactory" resource-ref="true"
		lookup-on-startup="true" expected-type="org.apache.activemq.ActiveMQConnectionFactory"
		proxy-interface="javax.jms.ConnectionFactory" />

	<!-- Vendite Menta (177) -->
	<jee:jndi-lookup id="venditeSendDestination"
		jndi-name="java:comp/env/jms/igeriv/vendite/177/queue" resource-ref="true"
		lookup-on-startup="true" expected-type="org.apache.activemq.command.ActiveMQQueue"
		proxy-interface="javax.jms.Queue" />

	<!-- Queue generica per i messaggi in timeout -->
	<jee:jndi-lookup id="venditeReplyDestination"
		jndi-name="java:comp/env/jms/igeriv/vendite/reply/queue" resource-ref="true"
		lookup-on-startup="true" expected-type="org.apache.activemq.command.ActiveMQQueue"
		proxy-interface="javax.jms.Queue" />

	<!-- Connection Pool Configuration -->
	<beans:bean id="connectionFactory"
		class="org.apache.activemq.pool.PooledConnectionFactory"
		destroy-method="stop">
		<beans:property name="maxConnections" value="8" />
		<beans:property name="maximumActive" value="500" />
		<beans:property name="connectionFactory" ref="jmsFactory" />
	</beans:bean>


	<!-- Configurazione Spring Integration per Invio / Ricezione Vendite -->

	<channel id="jmsSendChannel" />
	<channel id="jmsReplyChannel" />
	<channel id="jmsReplyTimeoutChannel" />
	<!-- Canale Menta (177) -->
	<channel id="jms177VenditeSendChannel" />

	<!-- Interfaccia di uscita -->
	<gateway id="sendGateway" default-request-channel="jmsSendChannel"
		service-interface="it.dpe.jms.send.SendGateway" />

	<!-- Esegue il routing al channel di uscita corretto basadosi sul header 
		del messaggio "header-name", il cui valore corrisponde al nome del channel -->
	<header-value-router input-channel="jmsSendChannel"
		header-name="channelName" resolution-required="true" />

	<!-- Definisce un invio assincrono senza risposta. Le risposte di conferma 
		della ricezione vendite da parte dei DL vengono invate sulla queue dedicata 
		venditeReplyDestination. Per implementare un pattern request/reply di tipo 
		sincrono con timeout utilizzare un outbound-gateway al posto del outbound-channel-adapter -->
	<jms:outbound-channel-adapter channel="jms177VenditeSendChannel"
		destination="venditeSendDestination" connection-factory="connectionFactory" />

	<!-- Ricezione dei messaggi di conferma dai DL -->
	<jms:message-driven-channel-adapter
		channel="jmsReplyChannel" destination="venditeReplyDestination"
		connection-factory="connectionFactory" />

	<!-- Definisce il bean che riceve il messaggio -->
	<service-activator input-channel="jmsReplyChannel"
		ref="VenditeReplyReceiver" method="receive" />

	<!-- Canale di errore -->
	<chain input-channel="errorChannel">
		<transformer ref="errorUnwrapper" method="transform" />
		<service-activator ref="IGerivErrorMessageHandler"
			method="onMessageFailed" />
	</chain>

	<!-- Genera un proxy sui JMX mbeans su cui sono esposti gli elementi (queue, 
		destinations, ecc) del ActiveMQ -->
	<beans:bean id="clientConnector"
		class="org.springframework.jmx.support.MBeanServerConnectionFactoryBean">
		<beans:property name="serviceUrl"
			value="service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi" />
		<beans:property name="connectOnStartup" value="false" />
	</beans:bean>

</beans:beans>
